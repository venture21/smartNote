# STT 예상 시간 예측 가이드

## 개요

SmartNote는 과거 STT 처리 기록을 분석하여 **예상 처리 시간**을 정확하게 예측합니다.

이 기능은 사용자에게 대기 시간을 미리 알려주어 더 나은 사용자 경험을 제공합니다.

---

## ✨ 주요 개선 사항

### 1. **가중 평균 (Weighted Average)**
최근 데이터에 더 높은 가중치를 부여하여 예측 정확도를 향상시킵니다.

```python
# 지수 가중치: 최근 데이터일수록 높은 가중치 (1.0 ~ 2.0)
weight = 1.0 + (i / len(ratios))  # 첫 번째: 1.0, 마지막: 2.0
weighted_sum += ratio * weight
weighted_avg_ratio = weighted_sum / weight_total
```

**효과**:
- 시스템 성능 변화에 빠르게 적응
- 최근 패턴 반영으로 정확도 향상

### 2. **이상치 제거 (Outlier Removal)**
표준편차 기반 필터링으로 비정상적인 데이터를 제거합니다.

```python
mean_ratio = statistics.mean(ratios)
stdev_ratio = statistics.stdev(ratios)

# 평균 ± 2 표준편차 범위 내의 값만 사용
filtered_ratios = [
    r for r in ratios
    if abs(r - mean_ratio) <= 2 * stdev_ratio
]
```

**효과**:
- 네트워크 지연, 시스템 과부하 등 일시적 문제로 인한 오차 제거
- 더 안정적인 예측

### 3. **오디오 길이별 구간 분석**
오디오 길이에 따라 다른 예측 모델을 사용합니다.

| 구간 | 오디오 길이 | 특성 |
|------|------------|------|
| **짧은 오디오** | 0~5분 (0~300초) | 처리 비율이 상대적으로 높음 |
| **중간 오디오** | 5~15분 (300~900초) | 가장 일반적인 케이스 |
| **긴 오디오** | 15분 이상 (900초~) | 처리 비율이 상대적으로 낮음 |

**효과**:
- 오디오 길이별 특성 반영
- 구간별 최적화된 예측

### 4. **예측 신뢰도 계산**
표준편차를 기반으로 예측의 신뢰도를 계산합니다.

```python
stdev = statistics.stdev(ratios)
confidence = max(0, 100 - (stdev * 100))  # 표준편차가 낮을수록 신뢰도 높음
```

**로그 예시**:
```
⏱️ STT 예상 시간: 97.2초
   (구간: medium, 샘플: 15개, 가중평균 비율: 0.172, 신뢰도: 95%)
```

### 5. **더 많은 메타데이터 저장**
기존 로그에 추가 정보를 저장합니다.

```json
{
  "audio_duration": 567.24,
  "processing_time": 97.43,
  "ratio": 0.1717,           // ← NEW: 처리 비율
  "source_type": "audio",    // ← NEW: 소스 타입
  "timestamp": "2025-10-31 13:04:58"
}
```

---

## 📊 예측 알고리즘

### 단계별 처리

```
1. 오디오 길이 확인 (예: 567초)
   ↓
2. 구간 분류 (short/medium/long)
   ↓
3. 해당 구간의 최근 50개 로그 선택
   ↓
4. 이상치 제거 (평균 ± 2 표준편차)
   ↓
5. 가중 평균 계산 (최근 데이터 가중치 ↑)
   ↓
6. 예상 시간 = 오디오 길이 × 가중평균 비율
   ↓
7. 신뢰도 계산 및 로그 출력
```

### 예시 계산

**입력**:
- 오디오 길이: 600초 (10분)
- 최근 로그: 20개 (구간: medium)

**처리**:
```python
# 1. 비율 추출
ratios = [0.15, 0.17, 0.16, 0.18, 0.14, ...]  # 20개

# 2. 이상치 제거 (평균: 0.16, 표준편차: 0.02)
filtered_ratios = [0.15, 0.17, 0.16, 0.18, 0.14, ...]  # 18개 (2개 제거)

# 3. 가중 평균 계산
# 첫 번째 비율: weight = 1.0
# 마지막 비율: weight = 2.0
weighted_avg_ratio = 0.165

# 4. 예상 시간
estimated = 600 * 0.165 = 99초
```

**출력**:
```
⏱️ STT 예상 시간: 99.0초
   (구간: medium, 샘플: 18개, 가중평균 비율: 0.165, 신뢰도: 92%)
```

---

## 🔧 함수 사용법

### 1. `add_stt_processing_record()`
STT 처리 완료 후 자동으로 기록을 추가합니다.

```python
# 오디오 처리 후 (legacy/youtube_search_viewer.py:2152)
add_stt_processing_record(
    audio_duration=567.24,     # 오디오 길이 (초)
    processing_time=97.43,     # 실제 처리 시간 (초)
    source_type="audio"        # "audio" 또는 "youtube"
)
```

**저장 위치**: `csv/stt_processing_log.json`

**로그 예시**:
```json
[
  {
    "audio_duration": 567.24,
    "processing_time": 97.43,
    "ratio": 0.1717,
    "source_type": "audio",
    "timestamp": "2025-10-31 13:04:58"
  },
  ...
]
```

### 2. `estimate_stt_processing_time()`
오디오 길이를 입력하면 예상 처리 시간을 반환합니다.

```python
# 예상 시간 계산 (legacy/youtube_search_viewer.py:1353)
estimated_time = estimate_stt_processing_time(audio_duration=567.24)
# 결과: 97.2초
```

**내부 로직**:
1. 로그 파일에서 과거 기록 로드
2. 오디오 길이로 구간 분류
3. 해당 구간의 최근 50개 로그 선택
4. 이상치 제거
5. 가중 평균 계산
6. 예상 시간 = 오디오 길이 × 가중평균 비율

### 3. `analyze_stt_prediction_accuracy()`
예측 정확도를 분석합니다.

```python
# 통계 분석 (legacy/youtube_search_viewer.py:464)
stats = analyze_stt_prediction_accuracy()

# 결과:
{
  "total_records": 50,
  "overall": {
    "mean_ratio": 0.1677,
    "median_ratio": 0.1410,
    "stdev_ratio": 0.0498,
    "min_ratio": 0.1356,
    "max_ratio": 0.2528
  },
  "by_duration": {
    "short": {...},
    "medium": {...},
    "long": {...}
  }
}
```

---

## 📈 예측 정확도 분석

### 테스트 실행
```bash
python test_stt_prediction.py
```

### 출력 예시
```
============================================================
📊 STT 예상 시간 예측 정확도 분석
============================================================

📈 전체 통계 (총 50개 기록)
------------------------------------------------------------
  평균 비율:  0.1677 (16.77%)
  중앙 비율:  0.1410 (14.10%)
  표준편차:   0.0498
  최소 비율:  0.1356 (13.56%)
  최대 비율:  0.2528 (25.28%)

📊 구간별 통계
------------------------------------------------------------

  짧은 오디오 (0~5분):
    기록 수:    10개
    평균 비율:  0.2100 (21.00%)
    중앙 비율:  0.2050 (20.50%)
    표준편차:   0.0300

  중간 오디오 (5~15분):
    기록 수:    30개
    평균 비율:  0.1650 (16.50%)
    중앙 비율:  0.1600 (16.00%)
    표준편차:   0.0400

  긴 오디오 (15분 이상):
    기록 수:    10개
    평균 비율:  0.1400 (14.00%)
    중앙 비율:  0.1380 (13.80%)
    표준편차:   0.0200

📝 최근 10개 기록
------------------------------------------------------------
      오디오 길이        처리 시간       비율         타입                   날짜
------------------------------------------------------------
     567.2초       97.4초  17.17%      audio  2025-10-31 13:04:58
     997.6초      137.1초  13.75%      audio  2025-10-31 13:22:24
    1193.5초      161.9초  13.56%    youtube  2025-10-31 13:42:50
     ...
```

### 분석 해석

1. **평균 비율 (mean_ratio)**
   - 오디오 길이 대비 평균 처리 시간 비율
   - 예: 0.1677 = 17.7% → 600초 오디오는 약 100초 소요

2. **중앙 비율 (median_ratio)**
   - 이상치의 영향을 덜 받는 중앙값
   - 평균과 차이가 크면 이상치가 많다는 의미

3. **표준편차 (stdev_ratio)**
   - 데이터의 분산 정도
   - 낮을수록 예측 신뢰도 ↑

4. **구간별 통계**
   - 짧은 오디오: 비율이 높음 (초기 오버헤드)
   - 긴 오디오: 비율이 낮음 (배치 효율성)

---

## 🎯 실제 사용 예시

### 프론트엔드에서 표시되는 정보

```
🎤 회의록 생성 (STT)                                    45%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
오디오에서 텍스트 추출 중... (예상: 97초, 경과: 45초, 남음: 52초)
```

### 백엔드 로그

```
⏱️ 예상 STT 처리 시간: 97.2초 (오디오 길이: 567.2초)
⏱️ STT 예상 시간: 97.2초 (구간: medium, 샘플: 15개, 가중평균 비율: 0.172, 신뢰도: 95%)
📊 이상치 제거: 18개 → 15개
🎧 Gemini STT API로 음성 인식 중: uploads/meeting.mp3
[task_id] stt: 0% - Gemini STT 시작 (예상: 97.2초, 경과: 0.0초, 남음: 97.2초)
[task_id] stt: 15% - 오디오에서 텍스트 추출 중... (예상: 97.2초, 경과: 15.0초, 남음: 82.2초)
...
[task_id] stt: 100% - Gemini STT 완료 (예상: 97.2초, 경과: 95.3초, 남음: 1.9초)
⏱️ Gemini STT 처리 시간: 95.3초
📊 STT 처리 기록 추가: 567.24초 → 95.30초 (비율: 0.168)
```

---

## 🔍 로그 파일 구조

### 위치
```
csv/stt_processing_log.json
```

### 형식
```json
[
  {
    "audio_duration": 567.24,      // 오디오 길이 (초)
    "processing_time": 97.43,      // 실제 처리 시간 (초)
    "ratio": 0.1717,               // 처리 비율 (processing_time / audio_duration)
    "source_type": "audio",        // 소스 타입 ("audio" 또는 "youtube")
    "timestamp": "2025-10-31 13:04:58"  // 처리 일시
  },
  ...
]
```

### 로그 관리
- **최대 200개** 기록 유지
- 오래된 기록은 자동 삭제 (FIFO)
- 구간별 최소 5개 이상 권장

---

## 📝 관련 파일

### 백엔드
- **`legacy/youtube_search_viewer.py`**
  - `add_stt_processing_record()` (321-349줄): 기록 추가
  - `estimate_stt_processing_time()` (352-461줄): 예측 계산
  - `analyze_stt_prediction_accuracy()` (464-549줄): 정확도 분석

### 프론트엔드
- **`templates/youtube_viewer.html`**
  - `updateAudioProgress()` (1931-1965줄): 오디오 진행 상황 표시
  - `updateVideoProgress()` (1248-1282줄): 영상 진행 상황 표시

### 테스트
- **`test_stt_prediction.py`**: 예측 정확도 분석 스크립트

### 로그
- **`csv/stt_processing_log.json`**: STT 처리 기록

---

## 💡 최적화 팁

### 1. 충분한 데이터 수집
- 최소 20개 이상의 기록 권장
- 구간별로 최소 5개 이상

### 2. 정기적인 정확도 확인
```bash
python test_stt_prediction.py
```

### 3. 이상치 모니터링
- 표준편차가 0.1 이상이면 이상치 확인 필요
- 네트워크 문제, 시스템 과부하 등 원인 파악

### 4. 구간별 데이터 균형
- 짧은/중간/긴 오디오를 골고루 처리하여 데이터 균형 유지

---

## 🎉 장점

1. **사용자 경험 개선**
   - 대기 시간 예측으로 답답함 감소
   - 실시간 진행 상황 확인

2. **정확도 향상**
   - 가중 평균으로 최근 패턴 반영
   - 이상치 제거로 안정적인 예측
   - 구간별 최적화

3. **자동화**
   - 처리 완료 시 자동 기록
   - 별도 관리 불필요

4. **모니터링**
   - 예측 정확도 분석 도구 제공
   - 로그 기반 성능 추적

---

**업데이트 날짜**: 2025-10-31
**관련 문서**: `README.md`, `SQLITE_DATABASE_GUIDE.md`
