<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ ì˜ìƒ/ì˜¤ë””ì˜¤ ê²€ìƒ‰ ì—”ì§„ v0.3</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- YouTube IFrame Player API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: var(--primary-color);
            background: rgba(var(--primary-rgb), 0.05);
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ì˜¤ë””ì˜¤ ì—…ë¡œë“œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgb), 0.05);
        }

        .file-upload-area.drag-over {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgb), 0.1);
        }

        .file-upload-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .file-upload-text {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .file-upload-hint {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .file-info {
            display: none;
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .file-info.show {
            display: block;
        }

        .file-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .file-info-item:last-child {
            margin-bottom: 0;
        }

        /* ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
        .audio-player-wrapper {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .audio-player-wrapper audio {
            width: 100%;
            height: 54px;
        }

        /* ì˜¤ë””ì˜¤ íƒ­ ì „ìš© ë ˆì´ì•„ì›ƒ - í”Œë ˆì´ì–´ ì—†ì´ ê°„ê²°í•˜ê²Œ */
        .audio-viewer-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            align-items: start;
            height: 800px; /* ëª…í™•í•œ ë†’ì´ ì„¤ì • */
        }

        .audio-left-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
        }

        /* ì˜¤ë””ì˜¤ íƒ­ì˜ íšŒì˜ë¡ ì»¨í…Œì´ë„ˆê°€ ì™¼ìª½(ìš”ì•½+ì±„íŒ…)ê³¼ ê°™ì€ ë†’ì´ ì‚¬ìš© */
        .audio-viewer-layout .transcript-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 800px;
        }

        .audio-viewer-layout .transcript-header {
            flex-shrink: 0; /* í—¤ë”ëŠ” ê³ ì • í¬ê¸° */
        }

        .audio-viewer-layout .transcript-content {
            flex: 1;
            overflow-y: auto !important;
            overflow-x: hidden;
            min-height: 0;
            height: auto !important;
            max-height: calc(800px - 80px); /* ì „ì²´ ë†’ì´ - í—¤ë” ë†’ì´ */
        }

        /* ìš”ì•½ê³¼ ì±„íŒ… ì»¨í…Œì´ë„ˆë„ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
        .audio-viewer-layout .summary-container,
        .audio-viewer-layout .chat-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .audio-viewer-layout .summary-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .audio-viewer-layout .chat-messages {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* ì˜¤ë””ì˜¤/ì˜ìƒ ì¬ìƒ ì¤‘ í˜„ì¬ ëŒ€í™” í•˜ì´ë¼ì´íŠ¸ */
        .transcript-segment.active-audio {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.3) 0%, rgba(59, 130, 246, 0.15) 100%) !important;
            border-left: 6px solid #2563eb !important;
            padding-left: 15px !important;
            margin-left: -10px !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
            transform: scale(1.02) !important;
        }

        .transcript-segment.active-audio .segment-header {
            color: #1d4ed8 !important;
            font-weight: 700 !important;
        }

        .transcript-segment.active-audio .segment-time {
            color: #2563eb !important;
            font-weight: 700 !important;
            background: rgba(59, 130, 246, 0.15);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 968px) {
            /* ì˜¤ë””ì˜¤ ë·°ì–´ ë ˆì´ì•„ì›ƒì„ ì„¸ë¡œë¡œ ë³€ê²½ */
            .audio-viewer-layout {
                display: flex !important;
                flex-direction: column !important;
                height: auto !important;
                gap: 20px;
            }

            .audio-viewer-layout .transcript-container {
                height: auto !important;
                max-height: 600px !important;
                order: 1; /* íšŒì˜ë¡ì„ ë§¨ ìœ„ë¡œ */
            }

            .audio-left-section {
                order: 2; /* ìš”ì•½+ì±„íŒ…ì„ ì•„ë˜ë¡œ */
            }

            .audio-viewer-layout .transcript-content {
                max-height: 500px !important;
            }

            .audio-viewer-layout .summary-container,
            .audio-viewer-layout .chat-container {
                height: 400px !important;
            }
        }

        @media (max-width: 768px) {
            /* ëª¨ë°”ì¼ ìµœì í™” */
            .audio-viewer-layout {
                display: flex !important;
                flex-direction: column !important;
                height: auto !important;
            }

            .audio-viewer-layout .transcript-container {
                height: auto !important;
                max-height: 500px !important;
                order: 1; /* íšŒì˜ë¡ì„ ë§¨ ìœ„ë¡œ */
            }

            .audio-left-section {
                order: 2; /* ìš”ì•½+ì±„íŒ…ì„ ì•„ë˜ë¡œ */
            }

            .audio-viewer-layout .transcript-content {
                max-height: 400px !important;
            }

            .audio-viewer-layout .summary-container,
            .audio-viewer-layout .chat-container {
                height: 350px !important;
            }

            /* ì˜¤ë””ì˜¤ ì •ë³´ ìµœì í™” */
            .video-info {
                font-size: 0.85rem !important;
                padding: 15px !important;
            }

            .info-row {
                flex-direction: column !important;
                gap: 8px !important;
            }
        }

        @media (max-width: 480px) {
            /* ì†Œí˜• ëª¨ë°”ì¼ */
            .audio-viewer-layout .transcript-container {
                max-height: 400px !important;
            }

            .audio-viewer-layout .transcript-content {
                max-height: 350px !important;
            }

            .audio-viewer-layout .summary-container,
            .audio-viewer-layout .chat-container {
                height: 300px !important;
            }

            /* ì„¸ê·¸ë¨¼íŠ¸ í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
            .transcript-segment {
                padding: 10px !important;
                font-size: 0.9rem !important;
            }
        }

        /* ë§ˆí¬ë‹¤ìš´ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
        .markdown-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
            color: var(--text-primary);
        }

        .markdown-content h1 {
            font-size: 2em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .markdown-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .markdown-content h3 {
            font-size: 1.25em;
        }

        .markdown-content p {
            margin-top: 0;
            margin-bottom: 16px;
            line-height: 1.8;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-top: 0;
            margin-bottom: 16px;
            padding-left: 2em;
        }

        .markdown-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .markdown-content li > p {
            margin-bottom: 8px;
        }

        .markdown-content code {
            padding: 2px 6px;
            background: rgba(var(--primary-rgb), 0.1);
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 16px;
        }

        .markdown-content pre code {
            padding: 0;
            background: none;
            border-radius: 0;
        }

        .markdown-content blockquote {
            margin: 0 0 16px 0;
            padding: 0 16px;
            border-left: 4px solid var(--primary-color);
            color: var(--text-secondary);
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 16px;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }

        .markdown-content table th {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .markdown-content a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content strong {
            font-weight: 600;
        }

        .markdown-content em {
            font-style: italic;
        }

        .markdown-content hr {
            height: 1px;
            padding: 0;
            margin: 24px 0;
            background-color: var(--border-color);
            border: 0;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header>
            <h1><span class="film-icon">ğŸ¬</span> ì˜ìƒ/ì˜¤ë””ì˜¤ ê²€ìƒ‰ ì—”ì§„ v0.2</h1>
        </header>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tabs">
            <button class="tab-button active" data-tab="video-tab">
                ğŸ¬ ì˜ìƒ ê²€ìƒ‰
            </button>
            <button class="tab-button" data-tab="audio-tab">
                ğŸµ ì˜¤ë””ì˜¤ ê²€ìƒ‰
            </button>
            <button class="tab-button" data-tab="retriever-tab">
                ğŸ” Retriever ê²€ìƒ‰
            </button>
            <button class="tab-button" data-tab="ask-content-tab">
                ğŸ’¬ ë‚´ìš© ì§ˆë¬¸
            </button>
            <button class="tab-button" data-tab="data-management-tab">
                ğŸ—‚ï¸ ë°ì´í„° ê´€ë¦¬
            </button>
        </div>

        <!-- ========== ì˜ìƒ ê²€ìƒ‰ íƒ­ ========== -->
        <div id="video-tab" class="tab-content active">
            <!-- YouTube URL ì…ë ¥ ì„¹ì…˜ -->
            <section class="upload-section" id="videoUploadSection">
                <div class="upload-card">
                    <h2>ğŸ”— YouTube URL ì…ë ¥</h2>
                    <p class="description">YouTube ì˜ìƒ URLì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì—¬ íšŒì˜ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤</p>

                    <form id="youtubeForm">
                        <div class="form-group">
                            <label for="youtubeUrl">YouTube URL</label>
                            <input
                                type="text"
                                id="youtubeUrl"
                                name="youtube_url"
                                placeholder="https://www.youtube.com/watch?v=..."
                                required
                                style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;"
                            >
                        </div>

                        <button type="submit" class="btn-primary" id="videoSubmitBtn">
                            <span class="btn-icon">ğŸ¤</span>
                            <span id="videoSubmitBtnText">ì˜ìƒ ì²˜ë¦¬ ì‹œì‘</span>
                        </button>
                    </form>

                    <div id="videoUploadStatus" class="upload-status"></div>

                    <!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
                    <div id="videoProgressSection" class="progress-section" style="display: none;">
                        <div class="progress-item">
                            <div class="progress-label">
                                <span>ğŸµ ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ & MP3 ë³€í™˜</span>
                                <span id="videoDownloadProgress">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="videoDownloadProgressBar" class="progress-fill"></div>
                            </div>
                            <div id="videoDownloadMessage" class="progress-message">ëŒ€ê¸° ì¤‘...</div>
                        </div>

                        <div class="progress-item">
                            <div class="progress-label">
                                <span>ğŸ¤ íšŒì˜ë¡ ìƒì„± (STT)</span>
                                <span id="videoSttProgress">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="videoSttProgressBar" class="progress-fill"></div>
                            </div>
                            <div id="videoSttMessage" class="progress-message">ëŒ€ê¸° ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ì˜ìƒ ë·°ì–´ ì„¹ì…˜ -->
            <section class="viewer-section" id="videoViewerSection" style="display: none;">
                <!-- ì˜ìƒ ì •ë³´ -->
                <div class="audio-player-container">
                    <div class="audio-header">
                        <h2>ğŸ“¹ ì˜ìƒ ì •ë³´</h2>
                        <button id="changeVideoBtn" class="btn-change-file" title="ë‹¤ë¥¸ ì˜ìƒ ì²˜ë¦¬">
                            ğŸ”— URL ë³€ê²½
                        </button>
                    </div>
                    <div class="video-info" id="videoInfo"></div>
                </div>

                <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ: í”Œë ˆì´ì–´+ìš”ì•½/ì±„íŒ… (ì™¼ìª½ 67%) | íšŒì˜ë¡ (ì˜¤ë¥¸ìª½ 33%) -->
                <div class="main-layout-grid">
                    <!-- ì™¼ìª½ ì˜ì—­: YouTube í”Œë ˆì´ì–´ + ìš”ì•½/ì±„íŒ… -->
                    <div class="left-section">
                        <!-- YouTube í”Œë ˆì´ì–´ -->
                        <div class="youtube-player-container">
                            <div class="audio-header">
                                <h2>ğŸ¬ YouTube í”Œë ˆì´ì–´</h2>
                            </div>
                            <div id="youtubePlayerWrapper">
                                <div id="youtubePlayer"></div>
                            </div>
                            <div class="player-info">
                                <span id="videoCurrentTime">00:00</span> / <span id="videoDuration">00:00</span>
                            </div>
                        </div>

                        <!-- ì œëª© ì…ë ¥ ì˜ì—­ -->
                        <div class="audio-player-container" style="margin-top: 10px;">
                            <label for="videoTitleInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                                ğŸ“ ì œëª© ì…ë ¥ (íšŒì˜ë¡ê³¼ ìš”ì•½ì„ VectorStoreì— ì €ì¥í•  ë•Œ ë©”íƒ€ë°ì´í„°ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤)
                            </label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input
                                    type="text"
                                    id="videoTitleInput"
                                    placeholder="íšŒì˜ë¡ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                    style="flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;"
                                >
                                <button id="saveVideoTitleBtn" class="btn-primary" style="flex: 0 0 auto; width: auto !important; padding: 10px 16px; white-space: nowrap; font-size: 0.9rem;">
                                    ì €ì¥
                                </button>
                            </div>
                            <div id="videoTitleStatus" style="margin-top: 8px; font-size: 0.9rem;"></div>
                        </div>

                        <!-- ìš”ì•½ ë° ì±„íŒ… ì˜ì—­ -->
                        <div class="bottom-content-grid">
                            <!-- ìš”ì•½ ì„¹ì…˜ -->
                            <div class="summary-container">
                                <div class="summary-header">
                                    <h2>ğŸ“‹ ì†Œì£¼ì œë³„ ìš”ì•½</h2>
                                    <button id="videoGenerateSummaryBtn" class="btn-primary">ìš”ì•½ ìƒì„±</button>
                                </div>
                                <div id="videoSummaryContent" class="summary-content">
                                    <p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                                </div>
                                <div id="videoSummaryLoading" class="loading-indicator" style="display: none;">
                                    <span class="spinner"></span> ìš”ì•½ ìƒì„± ì¤‘...
                                </div>
                            </div>

                            <!-- ì±„íŒ… ì„¹ì…˜ -->
                            <div class="chat-container">
                                <div class="chat-header">
                                    <h2>ğŸ’¬ AI ì±„íŒ…</h2>
                                    <button id="videoClearChatBtn" class="btn-clear-chat" title="ëŒ€í™” ì´ˆê¸°í™”">ğŸ—‘ï¸</button>
                                </div>
                                <div id="videoChatMessages" class="chat-messages">
                                    <div class="chat-welcome">
                                        íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                                    </div>
                                </div>
                                <div class="chat-input-container">
                                    <textarea
                                        id="videoChatInput"
                                        class="chat-input"
                                        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                        rows="2"
                                    ></textarea>
                                    <button id="videoSendChatBtn" class="btn-send-chat">
                                        <img src="{{ url_for('static', filename='images/chat_icon.png') }}?v=2" alt="Send" class="btn-icon-img">
                                    </button>
                                </div>
                                <div id="videoChatLoading" class="loading-indicator" style="display: none;">
                                    <span class="spinner"></span> ì‘ë‹µ ìƒì„± ì¤‘...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½ ì˜ì—­: íšŒì˜ë¡ (33%) -->
                    <div class="right-section">
                        <div class="transcript-container">
                            <div class="transcript-header">
                                <h2>ğŸ“ íšŒì˜ë¡</h2>
                                <div class="controls">
                                    <button id="videoAutoScrollToggle" class="btn-secondary active">ìë™ ìŠ¤í¬ë¡¤: ON</button>
                                    <span id="videoSegmentInfo">ì´ 0ê°œ ì„¸ê·¸ë¨¼íŠ¸</span>
                                </div>
                            </div>
                            <div id="videoTranscriptContent" class="transcript-content"></div>
                        </div>
                    </div>
                </div>

                <!-- VectorStore ì €ì¥ ë²„íŠ¼ -->
                <div class="audio-player-container" style="margin-top: 20px;">
                    <div style="text-align: center; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 2px solid var(--primary-color);">
                        <h3 style="margin-bottom: 16px; color: var(--primary-color);">ğŸ“¦ VectorStore ì €ì¥</h3>
                        <p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
                            ì œëª©ê³¼ ìš”ì•½ì„ ì…ë ¥í•œ í›„ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ VectorStoreì— ì €ì¥í•˜ì„¸ìš”.
                        </p>
                        <button id="saveVideoToVectorstoreBtn" class="btn-primary" style="padding: 16px 32px; font-size: 1.1rem;">
                            ğŸ’¾ VectorStoreì— ì €ì¥
                        </button>
                        <div id="videoVectorstoreSaveStatus" style="margin-top: 12px; font-size: 0.9rem;"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- ========== ì˜¤ë””ì˜¤ ê²€ìƒ‰ íƒ­ ========== -->
        <div id="audio-tab" class="tab-content">
            <!-- ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <section class="upload-section" id="audioUploadSection">
                <div class="upload-card">
                    <h2>ğŸ“ ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ</h2>
                    <p class="description">ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ íšŒì˜ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤</p>

                    <form id="audioForm">
                        <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="file-upload-icon">ğŸ“</div>
                            <div class="file-upload-text">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
                            <div class="file-upload-hint">ì§€ì› í˜•ì‹: MP3, WAV, M4A, FLAC, OGG (ìµœëŒ€ 500MB)</div>
                            <input type="file" id="audioFileInput" accept="audio/*,video/*" style="display: none;">
                        </div>

                        <!-- ì„ íƒëœ íŒŒì¼ ì •ë³´ -->
                        <div class="file-info" id="fileInfo">
                            <div class="file-info-item">
                                <strong>íŒŒì¼ëª…:</strong>
                                <span id="fileName">-</span>
                            </div>
                            <div class="file-info-item">
                                <strong>íŒŒì¼ í¬ê¸°:</strong>
                                <span id="fileSize">-</span>
                            </div>
                            <div class="file-info-item">
                                <strong>íŒŒì¼ í˜•ì‹:</strong>
                                <span id="fileType">-</span>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary" id="audioSubmitBtn" disabled>
                            <span class="btn-icon">ğŸ¤</span>
                            ì˜¤ë””ì˜¤ ì²˜ë¦¬ ì‹œì‘
                        </button>
                    </form>

                    <div id="audioUploadStatus" class="upload-status"></div>

                    <!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
                    <div id="audioProgressSection" class="progress-section" style="display: none;">
                        <div class="progress-item">
                            <div class="progress-label">
                                <span>ğŸ¤ íšŒì˜ë¡ ìƒì„± (STT)</span>
                                <span id="audioSttProgress">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="audioSttProgressBar" class="progress-fill"></div>
                            </div>
                            <div id="audioSttMessage" class="progress-message">ëŒ€ê¸° ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ì˜¤ë””ì˜¤ ë·°ì–´ ì„¹ì…˜ -->
            <section class="viewer-section" id="audioViewerSection" style="display: none;">
                <!-- ì˜¤ë””ì˜¤ ì •ë³´ -->
                <div class="audio-player-container">
                    <div class="audio-header">
                        <h2>ğŸµ ì˜¤ë””ì˜¤ ì •ë³´</h2>
                        <button id="changeAudioBtn" class="btn-change-file" title="ë‹¤ë¥¸ ì˜¤ë””ì˜¤ ì—…ë¡œë“œ">
                            ğŸ“ íŒŒì¼ ë³€ê²½
                        </button>
                    </div>
                    <div class="video-info" id="audioContentInfo"></div>
                </div>

                <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
                <div class="audio-player-container">
                    <div class="audio-header">
                        <h2>ğŸµ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´</h2>
                    </div>
                    <div class="audio-player-wrapper">
                        <audio id="audioPlayer" controls style="width: 100%;">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                </div>

                <!-- ì œëª© ì…ë ¥ ì˜ì—­ -->
                <div class="audio-player-container" style="margin-top: 10px;">
                    <label for="audioTitleInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                        ğŸ“ ì œëª© ì…ë ¥ (íšŒì˜ë¡ê³¼ ìš”ì•½ì„ VectorStoreì— ì €ì¥í•  ë•Œ ë©”íƒ€ë°ì´í„°ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤)
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input
                            type="text"
                            id="audioTitleInput"
                            placeholder="íšŒì˜ë¡ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                            style="flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;"
                        >
                        <button id="saveAudioTitleBtn" class="btn-primary" style="flex: 0 0 auto; width: auto !important; padding: 10px 16px; white-space: nowrap; font-size: 0.9rem;">
                            ì €ì¥
                        </button>
                    </div>
                    <div id="audioTitleStatus" style="margin-top: 8px; font-size: 0.9rem;"></div>
                </div>

                <!-- ì˜¤ë””ì˜¤ ì „ìš© ë ˆì´ì•„ì›ƒ: ìš”ì•½/ì±„íŒ… (ì™¼ìª½) | íšŒì˜ë¡ (ì˜¤ë¥¸ìª½) -->
                <div class="audio-viewer-layout">
                    <!-- ì™¼ìª½: ìš”ì•½ + ì±„íŒ… -->
                    <div class="audio-left-section">
                        <!-- ìš”ì•½ ì„¹ì…˜ -->
                        <div class="summary-container">
                            <div class="summary-header">
                                <h2>ğŸ“‹ ì†Œì£¼ì œë³„ ìš”ì•½</h2>
                                <button id="audioGenerateSummaryBtn" class="btn-primary">ìš”ì•½ ìƒì„±</button>
                            </div>
                            <div id="audioSummaryContent" class="summary-content">
                                <p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                            </div>
                            <div id="audioSummaryLoading" class="loading-indicator" style="display: none;">
                                <span class="spinner"></span> ìš”ì•½ ìƒì„± ì¤‘...
                            </div>
                        </div>

                        <!-- ì±„íŒ… ì„¹ì…˜ -->
                        <div class="chat-container">
                            <div class="chat-header">
                                <h2>ğŸ’¬ AI ì±„íŒ…</h2>
                                <button id="audioClearChatBtn" class="btn-clear-chat" title="ëŒ€í™” ì´ˆê¸°í™”">ğŸ—‘ï¸</button>
                            </div>
                            <div id="audioChatMessages" class="chat-messages">
                                <div class="chat-welcome">
                                    íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <textarea
                                    id="audioChatInput"
                                    class="chat-input"
                                    placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                    rows="2"
                                ></textarea>
                                <button id="audioSendChatBtn" class="btn-send-chat">
                                    <img src="{{ url_for('static', filename='images/chat_icon.png') }}?v=2" alt="Send" class="btn-icon-img">
                                </button>
                            </div>
                            <div id="audioChatLoading" class="loading-indicator" style="display: none;">
                                <span class="spinner"></span> ì‘ë‹µ ìƒì„± ì¤‘...
                            </div>
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½: íšŒì˜ë¡ -->
                    <div class="transcript-container">
                        <div class="transcript-header">
                            <h2>ğŸ“ íšŒì˜ë¡</h2>
                            <div class="controls">
                                <button id="audioAutoScrollToggle" class="btn-secondary active">ìë™ ìŠ¤í¬ë¡¤: ON</button>
                                <span id="audioSegmentInfo">ì´ 0ê°œ ì„¸ê·¸ë¨¼íŠ¸</span>
                            </div>
                        </div>
                        <div id="audioTranscriptContent" class="transcript-content"></div>
                    </div>
                </div>

                <!-- VectorStore ì €ì¥ ë²„íŠ¼ -->
                <div class="audio-player-container" style="margin-top: 20px;">
                    <div style="text-align: center; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 2px solid var(--primary-color);">
                        <h3 style="margin-bottom: 16px; color: var(--primary-color);">ğŸ“¦ VectorStore ì €ì¥</h3>
                        <p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
                            ì œëª©ê³¼ ìš”ì•½ì„ ì…ë ¥í•œ í›„ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ VectorStoreì— ì €ì¥í•˜ì„¸ìš”.
                        </p>
                        <button id="saveAudioToVectorstoreBtn" class="btn-primary" style="padding: 16px 32px; font-size: 1.1rem;">
                            ğŸ’¾ VectorStoreì— ì €ì¥
                        </button>
                        <div id="audioVectorstoreSaveStatus" style="margin-top: 12px; font-size: 0.9rem;"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- ========== Retriever ê²€ìƒ‰ íƒ­ ========== -->
        <div id="retriever-tab" class="tab-content">
            <!-- Retriever ê²€ìƒ‰ ì„¹ì…˜ -->
            <section class="upload-section">
                <div class="upload-card">
                    <h2>ğŸ” VectorStore ê²€ìƒ‰</h2>
                    <p class="description">YouTube ë° ì˜¤ë””ì˜¤ VectorStoreì—ì„œ ê´€ë ¨ íšŒì˜ë¡ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤</p>

                    <form id="retrieverForm">
                        <div class="form-group">
                            <label for="retrieverQuery">ê²€ìƒ‰ì–´</label>
                            <input
                                type="text"
                                id="retrieverQuery"
                                name="query"
                                placeholder="ê²€ìƒ‰í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                required
                                style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;"
                            >
                        </div>

                        <div class="form-group">
                            <label>ê²€ìƒ‰ ëŒ€ìƒ ì„ íƒ</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="source_type" value="all" checked>
                                    <span class="radio-text">
                                        <strong>ì „ì²´ ê²€ìƒ‰</strong>
                                        <small>YouTube + Audio ëª¨ë‘ ê²€ìƒ‰</small>
                                    </span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="source_type" value="summary">
                                    <span class="radio-text">
                                        <strong>ìš”ì•½ ê²€ìƒ‰</strong>
                                        <small>íšŒì˜ ìš”ì•½ë§Œ ê²€ìƒ‰</small>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="retrieverResults">ê²€ìƒ‰ ê²°ê³¼ ìˆ˜</label>
                            <select id="retrieverResults" name="n_results" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                                <option value="1">1ê°œ</option>
                                <option value="2">2ê°œ</option>
                                <option value="5" selected>5ê°œ</option>
                                <option value="10">10ê°œ</option>
                                <option value="15">15ê°œ</option>
                                <option value="20">20ê°œ</option>
                            </select>
                        </div>

                        <button type="submit" class="btn-primary">
                            <span class="btn-icon">ğŸ”</span>
                            ê²€ìƒ‰
                        </button>
                    </form>

                    <div id="retrieverStatus" class="upload-status"></div>
                </div>
            </section>

            <!-- ê²€ìƒ‰ ê²°ê³¼ ì„¹ì…˜ -->
            <section class="viewer-section" id="retrieverResultsSection" style="display: none;">
                <!-- í”Œë ˆì´ì–´ ì˜ì—­ -->
                <div id="retrieverPlayerSection" style="display: none; margin-bottom: 20px;">
                    <div class="audio-player-container">
                        <div class="audio-header">
                            <h2 id="retrieverPlayerTitle">ğŸµ í”Œë ˆì´ì–´</h2>
                            <button id="retrieverClosePlayerBtn" class="btn-secondary" style="padding: 8px 16px;">
                                âœ• ë‹«ê¸°
                            </button>
                        </div>

                        <!-- YouTube í”Œë ˆì´ì–´ -->
                        <div id="retrieverYoutubePlayerWrapper" style="display: none;">
                            <div id="retrieverYoutubePlayer"></div>
                            <div class="player-info" style="margin-top: 10px;">
                                <span id="retrieverVideoCurrentTime">00:00</span> / <span id="retrieverVideoDuration">00:00</span>
                            </div>
                        </div>

                        <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
                        <div id="retrieverAudioPlayerWrapper" class="audio-player-wrapper" style="display: none;">
                            <audio id="retrieverAudioPlayer" controls style="width: 100%;">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                </div>

                <div class="transcript-container" style="max-height: none; height: auto;">
                    <div class="transcript-header">
                        <h2>ğŸ“Š ê²€ìƒ‰ ê²°ê³¼</h2>
                        <div class="controls">
                            <span id="retrieverResultInfo">ê²€ìƒ‰ ê²°ê³¼: 0ê°œ</span>
                        </div>
                    </div>
                    <div id="retrieverResultsContent" class="transcript-content" style="max-height: none; height: auto; min-height: 400px;">
                        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </section>
        </div>

        <!-- ========== ë‚´ìš© ì§ˆë¬¸ íƒ­ ========== -->
        <div id="ask-content-tab" class="tab-content">
            <!-- ì§ˆë¬¸ ì…ë ¥ ì„¹ì…˜ -->
            <section class="upload-section">
                <div class="upload-card">
                    <h2>ğŸ’¬ ë‚´ìš© ì§ˆë¬¸ (RAG)</h2>
                    <p class="description">VectorStoreì—ì„œ ê´€ë ¨ ë‚´ìš©ì„ ê²€ìƒ‰í•˜ì—¬ AIê°€ ë‹µë³€í•©ë‹ˆë‹¤</p>

                    <form id="askContentForm">
                        <div class="form-group">
                            <label for="contentQuestion">ì§ˆë¬¸</label>
                            <textarea
                                id="contentQuestion"
                                name="question"
                                placeholder="íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”..."
                                required
                                style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; min-height: 100px; resize: vertical;"
                            ></textarea>
                        </div>

                        <div class="form-group">
                            <label>ê²€ìƒ‰ ì„¤ì •</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label for="transcriptCount" style="font-size: 0.9rem; color: var(--text-secondary);">
                                        ì „ì²´ ê²€ìƒ‰ ê°œìˆ˜
                                    </label>
                                    <select id="transcriptCount" name="transcript_n" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; margin-top: 5px;">
                                        <option value="1">1ê°œ</option>
                                        <option value="2">2ê°œ</option>
                                        <option value="3">3ê°œ</option>
                                        <option value="5" selected>5ê°œ</option>
                                        <option value="10">10ê°œ</option>
                                    </select>
                                    <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                                        íšŒì˜ë¡ ì „ì²´ì—ì„œ ê²€ìƒ‰
                                    </small>
                                </div>
                                <div>
                                    <label for="summaryCount" style="font-size: 0.9rem; color: var(--text-secondary);">
                                        ìš”ì•½ ê²€ìƒ‰ ê°œìˆ˜
                                    </label>
                                    <select id="summaryCount" name="summary_n" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; margin-top: 5px;">
                                        <option value="1">1ê°œ</option>
                                        <option value="2">2ê°œ</option>
                                        <option value="3">3ê°œ</option>
                                        <option value="5" selected>5ê°œ</option>
                                        <option value="10">10ê°œ</option>
                                    </select>
                                    <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                                        íšŒì˜ ìš”ì•½ì—ì„œ ê²€ìƒ‰
                                    </small>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary" id="askContentBtn">
                            <span class="btn-icon">ğŸ’¬</span>
                            <span id="askContentBtnText">ì§ˆë¬¸í•˜ê¸°</span>
                        </button>
                    </form>

                    <div id="askContentStatus" class="upload-status"></div>
                </div>
            </section>

            <!-- ë‹µë³€ í‘œì‹œ ì„¹ì…˜ -->
            <section class="viewer-section" id="askContentAnswerSection" style="display: none;">
                <div class="transcript-box">
                    <div class="transcript-header">
                        <h2>ğŸ’¡ ë‹µë³€</h2>
                        <div class="controls">
                            <span id="askContentResultInfo">ê²€ìƒ‰: ì „ì²´ 0ê°œ, ìš”ì•½ 0ê°œ</span>
                        </div>
                    </div>
                    <div id="askContentAnswer" class="transcript-content markdown-content" style="max-height: none; height: auto; min-height: 300px; line-height: 1.8; padding: 20px;">
                        <!-- ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- ê²€ìƒ‰ëœ ì»¨í…ìŠ¤íŠ¸ í‘œì‹œ (ì ‘ì„ ìˆ˜ ìˆìŒ) -->
                <details style="margin-top: 20px;" open>
                    <summary style="cursor: pointer; font-weight: bold; padding: 10px; background: var(--card-bg); border-radius: 8px; margin-bottom: 10px;">
                        ğŸ“š ì°¸ê³ í•œ ê²€ìƒ‰ ê²°ê³¼
                    </summary>

                    <!-- ìš”ì•½ ê²€ìƒ‰ ê²°ê³¼ (ë¨¼ì € í‘œì‹œ) -->
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 10px;">ğŸ“ ìš”ì•½ ê²€ìƒ‰ ê²°ê³¼</h3>
                        <div id="askContentSummaryResults" class="transcript-content" style="max-height: 400px; overflow-y: auto;">
                            <!-- ìš”ì•½ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>

                    <!-- ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ (Citation ê¸°ë°˜) -->
                    <div>
                        <h3 style="font-size: 1.1rem; margin-bottom: 10px;">ğŸ” ì›ë¬¸ ì„¸ê·¸ë¨¼íŠ¸ (ìš”ì•½ì—ì„œ ì¸ìš©ëœ ë‚´ìš©)</h3>
                        <div id="askContentTranscriptResults" class="transcript-content" style="max-height: 400px; overflow-y: auto;">
                            <!-- ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </details>
            </section>
        </div>

        <!-- ========== ë°ì´í„° ê´€ë¦¬ íƒ­ ========== -->
        <div id="data-management-tab" class="tab-content">
            <!-- í†µê³„ ì„¹ì…˜ -->
            <section class="upload-section">
                <div class="upload-card">
                    <h2>ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ í†µê³„</h2>
                    <div id="dbStats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                        <!-- í†µê³„ ë¡œë“œ ì¤‘... -->
                    </div>
                    <button onclick="loadDataList()" class="btn-primary" style="margin-top: 20px;">
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </section>

            <!-- ëª©ë¡ ì„¹ì…˜ -->
            <section class="viewer-section">
                <div class="transcript-box">
                    <div class="transcript-header">
                        <h2>ğŸ“¹ YouTube ì˜ìƒ ëª©ë¡</h2>
                    </div>
                    <div id="youtubeList" class="transcript-content" style="max-height: 400px;">
                        <p style="text-align: center; color: var(--text-muted);">ë¡œë”© ì¤‘...</p>
                    </div>
                </div>

                <div class="transcript-box" style="margin-top: 20px;">
                    <div class="transcript-header">
                        <h2>ğŸµ ì˜¤ë””ì˜¤ íŒŒì¼ ëª©ë¡</h2>
                    </div>
                    <div id="audioList" class="transcript-content" style="max-height: 400px;">
                        <p style="text-align: center; color: var(--text-muted);">ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // ========== ì˜ìƒ ê²€ìƒ‰ íƒ­ ì „ì—­ ë³€ìˆ˜ ==========
        let videoSessionId = null;
        let videoId = null;
        let videoSegments = [];
        let videoChatHistory = [];
        let youtubePlayer = null;
        let videoAutoScrollEnabled = true;
        let videoTaskId = null;
        let videoTitle = null;  // ì €ì¥ëœ ì œëª©
        let videoProgressInterval = null;

        // ========== ì˜¤ë””ì˜¤ ê²€ìƒ‰ íƒ­ ì „ì—­ ë³€ìˆ˜ ==========
        let audioSessionId = null;
        let audioFileHash = null;  // ì˜¤ë””ì˜¤ íŒŒì¼ í•´ì‹œ (source_idë¡œ ì‚¬ìš©)
        let audioSegments = [];
        let audioChatHistory = [];
        let audioElement = null;
        let audioAutoScrollEnabled = true;
        let audioTaskId = null;
        let audioProgressInterval = null;
        let selectedAudioFile = null;
        let audioTitle = null;  // ì €ì¥ëœ ì œëª©
        let audioFilename = null;  // ë°±ì—”ë“œì—ì„œ ë°˜í™˜ëœ ì‹¤ì œ íŒŒì¼ëª…
        let audioTimeUpdateHandler = null;  // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì°¸ì¡° ì €ì¥

        // ========== Retriever íƒ­ ì „ì—­ ë³€ìˆ˜ ==========
        let retrieverYoutubePlayer = null;
        let retrieverAudioPlayer = null;

        // ========== ê³µí†µ í•¨ìˆ˜ ==========
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ========== íƒ­ ì „í™˜ ==========
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;

                // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                // ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¹€
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // ì„ íƒëœ íƒ­ í™œì„±í™”
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // ========================================
        // ì˜ìƒ ê²€ìƒ‰ íƒ­ ë¡œì§
        // ========================================

        // YouTube í¼ ì œì¶œ
        document.getElementById('youtubeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const youtubeUrl = document.getElementById('youtubeUrl').value.trim();

            if (!youtubeUrl) {
                alert('YouTube URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° í…ìŠ¤íŠ¸ ë³€ê²½
            const submitBtn = document.getElementById('videoSubmitBtn');
            const submitBtnText = document.getElementById('videoSubmitBtnText');
            submitBtn.disabled = true;
            submitBtnText.textContent = 'ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ë° í…ìŠ¤íŠ¸ ìƒì„±ì¤‘';

            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì´ˆê¸°í™” (0%ë¡œ ë¦¬ì…‹)
            document.getElementById('videoDownloadProgress').textContent = '0%';
            document.getElementById('videoDownloadProgressBar').style.width = '0%';
            document.getElementById('videoDownloadMessage').textContent = 'ëŒ€ê¸° ì¤‘...';
            document.getElementById('videoSttProgress').textContent = '0%';
            document.getElementById('videoSttProgressBar').style.width = '0%';
            document.getElementById('videoSttMessage').textContent = 'ëŒ€ê¸° ì¤‘...';

            // UI ìƒíƒœ ë³€ê²½
            document.getElementById('videoUploadStatus').innerHTML = '<p style="color: #666;">ì²˜ë¦¬ ì¤‘...</p>';
            document.getElementById('videoProgressSection').style.display = 'block';

            try {
                const response = await fetch('/api/process-youtube', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        youtube_url: youtubeUrl
                    })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.cached) {
                        displayVideoResult(data);
                    } else if (data.processing) {
                        videoTaskId = data.task_id;
                        startVideoProgressPolling();
                    }
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                    document.getElementById('videoProgressSection').style.display = 'none';
                    // ë²„íŠ¼ ì¬í™œì„±í™”
                    submitBtn.disabled = false;
                    submitBtnText.textContent = 'ì˜ìƒ ì²˜ë¦¬ ì‹œì‘';
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                document.getElementById('videoProgressSection').style.display = 'none';
                // ë²„íŠ¼ ì¬í™œì„±í™”
                const submitBtn = document.getElementById('videoSubmitBtn');
                const submitBtnText = document.getElementById('videoSubmitBtnText');
                submitBtn.disabled = false;
                submitBtnText.textContent = 'ì˜ìƒ ì²˜ë¦¬ ì‹œì‘';
            }
        });

        // ì˜ìƒ ì§„í–‰ ìƒí™© í´ë§
        function startVideoProgressPolling() {
            if (videoProgressInterval) {
                clearInterval(videoProgressInterval);
            }

            videoProgressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/progress/${videoTaskId}`);
                    const data = await response.json();

                    if (data.success) {
                        const progress = data.progress;

                        if (progress.download) {
                            updateVideoProgress('download', progress.download.progress, progress.download.message, progress.download);
                        }

                        if (progress.stt) {
                            updateVideoProgress('stt', progress.stt.progress, progress.stt.message, progress.stt);
                        }

                        if (progress.vectorstore) {
                            updateVideoProgress('vectorstore', progress.vectorstore.progress, progress.vectorstore.message, progress.vectorstore);
                        }

                        if (progress.completed && progress.result) {
                            clearInterval(videoProgressInterval);
                            // ìµœì¢… ì‹œê°„ ì •ë³´ í‘œì‹œ
                            if (progress.stt) {
                                updateVideoProgress('stt', 100, progress.stt.message, progress.stt);
                            }
                            displayVideoResult(progress.result);
                        }

                        if (progress.error) {
                            clearInterval(videoProgressInterval);
                            alert('ì˜¤ë¥˜: ' + progress.error.message);
                            document.getElementById('videoProgressSection').style.display = 'none';
                            // ë²„íŠ¼ ì¬í™œì„±í™”
                            const submitBtn = document.getElementById('videoSubmitBtn');
                            const submitBtnText = document.getElementById('videoSubmitBtnText');
                            submitBtn.disabled = false;
                            submitBtnText.textContent = 'ì˜ìƒ ì²˜ë¦¬ ì‹œì‘';
                        }
                    }
                } catch (error) {
                    console.error('ì§„í–‰ ìƒí™© ì¡°íšŒ ì˜¤ë¥˜:', error);
                }
            }, 1000);
        }

        function updateVideoProgress(type, percent, message, progressData = null) {
            const progressSpan = document.getElementById(`video${type.charAt(0).toUpperCase() + type.slice(1)}Progress`);
            const progressBar = document.getElementById(`video${type.charAt(0).toUpperCase() + type.slice(1)}ProgressBar`);
            const messageDiv = document.getElementById(`video${type.charAt(0).toUpperCase() + type.slice(1)}Message`);

            if (progressSpan) progressSpan.textContent = `${percent}%`;
            if (progressBar) progressBar.style.width = `${percent}%`;

            // ì‹œê°„ ì •ë³´ í¬í•¨ ë©”ì‹œì§€ ìƒì„±
            if (messageDiv) {
                let fullMessage = message;

                if (progressData && (progressData.estimated_time || progressData.elapsed_time)) {
                    const timeInfo = [];

                    if (progressData.estimated_time !== undefined) {
                        timeInfo.push(`ì˜ˆìƒ: ${Math.round(progressData.estimated_time)}ì´ˆ`);
                    }

                    if (progressData.elapsed_time !== undefined) {
                        timeInfo.push(`ê²½ê³¼: ${Math.round(progressData.elapsed_time)}ì´ˆ`);
                    }

                    if (progressData.remaining_time !== undefined) {
                        timeInfo.push(`ë‚¨ìŒ: ${Math.round(progressData.remaining_time)}ì´ˆ`);
                    }

                    if (timeInfo.length > 0) {
                        fullMessage += ` (${timeInfo.join(', ')})`;
                    }
                }

                messageDiv.textContent = fullMessage;
            }
        }

        // ì˜ìƒ ê²°ê³¼ í‘œì‹œ
        function displayVideoResult(data) {
            videoSessionId = data.session_id;
            videoId = data.video_id;
            videoSegments = data.segments;

            // ë²„íŠ¼ ì¬í™œì„±í™”
            const submitBtn = document.getElementById('videoSubmitBtn');
            const submitBtnText = document.getElementById('videoSubmitBtnText');
            submitBtn.disabled = false;
            submitBtnText.textContent = 'ì˜ìƒ ì²˜ë¦¬ ì‹œì‘';

            // ì—…ë¡œë“œ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('videoUploadSection').style.display = 'none';
            document.getElementById('videoViewerSection').style.display = 'block';

            // ì˜ìƒ ì •ë³´ í‘œì‹œ
            document.getElementById('videoInfo').innerHTML = `
                <div class="info-row">
                    <div class="info-item">
                        <strong>ì œëª©:</strong> <span>${data.title}</span>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-item">
                        <strong>ì±„ë„:</strong> <span>${data.channel}</span>
                    </div>
                    <div class="info-item">
                        <strong>ì¡°íšŒìˆ˜:</strong> <span>${data.view_count.toLocaleString()}</span>
                    </div>
                    <div class="info-item">
                        <strong>ì—…ë¡œë“œ ë‚ ì§œ:</strong> <span>${data.upload_date}</span>
                    </div>
                    <div class="info-item">
                        <strong>ì²˜ë¦¬ ì¼ì‹œ:</strong> <span>${data.created_at}</span>
                    </div>
                </div>
            `;

            // YouTube Player ì´ˆê¸°í™”
            if (!youtubePlayer) {
                youtubePlayer = new YT.Player('youtubePlayer', {
                    videoId: data.video_id,
                    width: '100%',
                    height: '400',
                    playerVars: {
                        'autoplay': 0,
                        'controls': 1
                    },
                    events: {
                        'onReady': onYouTubePlayerReady,
                        'onStateChange': onYouTubePlayerStateChange
                    }
                });
            } else {
                youtubePlayer.loadVideoById(data.video_id);
            }

            // íšŒì˜ë¡ í‘œì‹œ
            displayVideoTranscript(data.segments);

            // ìš”ì•½ ë¨¼ì € ì´ˆê¸°í™” (ë¬´ì¡°ê±´)
            videoRawSummary = '';  // ì›ë³¸ ë§ˆí¬ë‹¤ìš´ ì´ˆê¸°í™”
            document.getElementById('videoSummaryContent').innerHTML = '<p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>';

            // ìš”ì•½ì´ ìˆê³  ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ í‘œì‹œ
            if (data.summary && data.summary.trim() !== '') {
                videoRawSummary = data.summary;  // ìºì‹œëœ ì›ë³¸ ë§ˆí¬ë‹¤ìš´ ì €ì¥
                document.getElementById('videoSummaryContent').innerHTML = marked.parse(data.summary);
                console.log('[Video] Loaded cached summary and raw markdown.');
            }

            // ì±„íŒ… ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì˜ìƒì´ë¯€ë¡œ)
            document.getElementById('videoChatMessages').innerHTML = `
                <div class="chat-welcome">
                    íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                </div>
            `;
            videoChatHistory = [];

            // ì§„í–‰ ìƒí™© ìˆ¨ê¸°ê¸°
            document.getElementById('videoProgressSection').style.display = 'none';

            console.log('[Video] New video loaded. Summary and chat initialized.');
        }

        // ì˜ìƒ íšŒì˜ë¡ í‘œì‹œ
        // ì˜ìƒ ì„¸ê·¸ë¨¼íŠ¸ ìë™ ì •ì§€ìš©
        let videoSegmentStopInterval = null;

        function displayVideoTranscript(segments) {
            const transcriptContent = document.getElementById('videoTranscriptContent');
            transcriptContent.innerHTML = '';

            segments.forEach((segment, idx) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'transcript-segment';
                segmentDiv.dataset.time = segment.start_time;
                segmentDiv.dataset.id = segment.id;

                // end_time ê³„ì‚° (ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ì˜ start_time)
                const endTime = idx < segments.length - 1 ? segments[idx + 1].start_time : null;
                if (endTime) {
                    segmentDiv.dataset.endTime = endTime;
                }

                const minutes = Math.floor(segment.start_time / 60);
                const seconds = Math.floor(segment.start_time % 60);
                const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                // end_time í‘œì‹œ
                let timeRangeStr = timeStr;
                if (endTime) {
                    const endMinutes = Math.floor(endTime / 60);
                    const endSeconds = Math.floor(endTime % 60);
                    const endTimeStr = `${String(endMinutes).padStart(2, '0')}:${String(endSeconds).padStart(2, '0')}`;
                    timeRangeStr = `${timeStr} ~ ${endTimeStr}`;
                }

                segmentDiv.innerHTML = `
                    <div class="segment-header">
                        <span class="segment-speaker">í™”ì ${segment.speaker}</span>
                        <span class="segment-time">${timeRangeStr}</span>
                    </div>
                    <div class="segment-text">${segment.text}</div>
                `;

                segmentDiv.addEventListener('click', () => {
                    if (youtubePlayer) {
                        // ê¸°ì¡´ interval ì œê±°
                        if (videoSegmentStopInterval) {
                            clearInterval(videoSegmentStopInterval);
                        }

                        console.log(`[Video] ìë™ ìŠ¤í¬ë¡¤ ìƒíƒœ: ${videoAutoScrollEnabled ? 'ON' : 'OFF'}, endTime: ${endTime}`);

                        // ì‹œì‘ ìœ„ì¹˜ë¡œ ì´ë™ í›„ ì¬ìƒ
                        youtubePlayer.seekTo(segment.start_time, true);
                        youtubePlayer.playVideo();

                        // ìë™ ìŠ¤í¬ë¡¤ OFFì´ê³  end_timeì´ ìˆìœ¼ë©´ ìë™ ì •ì§€ ì„¤ì •
                        if (!videoAutoScrollEnabled && endTime) {
                            console.log(`[Video] ìë™ ì •ì§€ ì„¤ì •: ${segment.start_time}s ~ ${endTime}s`);
                            videoSegmentStopInterval = setInterval(() => {
                                const currentTime = youtubePlayer.getCurrentTime();
                                if (currentTime >= endTime) {
                                    youtubePlayer.pauseVideo();
                                    clearInterval(videoSegmentStopInterval);
                                    console.log(`[Video] Auto-stopped at ${endTime}s`);
                                }
                            }, 100);
                        } else {
                            console.log(`[Video] ì—°ì† ì¬ìƒ ëª¨ë“œ (ìë™ ì •ì§€ ì•ˆ í•¨)`);
                        }
                    }
                });

                transcriptContent.appendChild(segmentDiv);
            });

            document.getElementById('videoSegmentInfo').textContent = `ì´ ${segments.length}ê°œ ì„¸ê·¸ë¨¼íŠ¸`;
        }

        // ì˜ìƒ ìš”ì•½ ìƒì„±
        let videoRawSummary = '';  // ì›ë³¸ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ ì €ì¥ìš©
        document.getElementById('videoGenerateSummaryBtn').addEventListener('click', async () => {
            document.getElementById('videoSummaryLoading').style.display = 'block';
            document.getElementById('videoSummaryContent').innerHTML = '';

            try {
                const response = await fetch('/api/summarize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        segments: videoSegments,
                        session_id: videoSessionId,
                        title: videoTitle  // ì €ì¥ëœ ì œëª©ì„ ìš”ì•½ ìƒì„± ì‹œ ì°¸ì¡°
                    })
                });

                const data = await response.json();

                if (data.success) {
                    videoRawSummary = data.summary;  // ì›ë³¸ ë§ˆí¬ë‹¤ìš´ ì €ì¥ (citation í¬í•¨)
                    document.getElementById('videoSummaryContent').innerHTML = marked.parse(data.summary);
                    console.log('[Video] Raw summary saved for VectorStore');
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('videoSummaryLoading').style.display = 'none';
            }
        });

        // ì˜ìƒ ì±„íŒ… ì „ì†¡
        document.getElementById('videoSendChatBtn').addEventListener('click', () => sendVideoChatMessage());
        document.getElementById('videoChatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendVideoChatMessage();
            }
        });

        async function sendVideoChatMessage() {
            const chatInput = document.getElementById('videoChatInput');
            const message = chatInput.value.trim();

            if (!message) return;

            const chatMessages = document.getElementById('videoChatMessages');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message user-message';
            userMessageDiv.innerHTML = `<div class="message-content">${message}</div>`;
            chatMessages.appendChild(userMessageDiv);

            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            document.getElementById('videoChatLoading').style.display = 'block';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        segments: videoSegments,
                        session_id: videoSessionId,
                        chat_history: videoChatHistory
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = 'chat-message ai-message';
                    aiMessageDiv.innerHTML = `<div class="message-content">${marked.parse(data.response)}</div>`;
                    chatMessages.appendChild(aiMessageDiv);

                    videoChatHistory = data.chat_history;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ì±„íŒ… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('videoChatLoading').style.display = 'none';
            }
        }

        // ì˜ìƒ ì±„íŒ… ì´ˆê¸°í™”
        document.getElementById('videoClearChatBtn').addEventListener('click', () => {
            if (confirm('ëŒ€í™” ë‚´ì—­ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('videoChatMessages').innerHTML = `
                    <div class="chat-welcome">
                        íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                    </div>
                `;
                videoChatHistory = [];
            }
        });

        // ì˜ìƒ ì œëª© ì €ì¥
        document.getElementById('saveVideoTitleBtn').addEventListener('click', () => {
            const title = document.getElementById('videoTitleInput').value.trim();
            const statusDiv = document.getElementById('videoTitleStatus');

            if (!title) {
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>';
                return;
            }

            // ì œëª©ì„ ë³€ìˆ˜ì— ì €ì¥
            videoTitle = title;
            statusDiv.innerHTML = '<span style="color: #10b981;">âœ… ì œëª©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìš”ì•½ ìƒì„± ë° VectorStore ì €ì¥ ì‹œ ì‚¬ìš©ë©ë‹ˆë‹¤.</span>';

            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);

            console.log('[Video] ì œëª© ì €ì¥ë¨:', videoTitle);
        });

        // YouTube VectorStore ì €ì¥
        document.getElementById('saveVideoToVectorstoreBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('videoVectorstoreSaveStatus');
            const saveBtn = document.getElementById('saveVideoToVectorstoreBtn');

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!videoId) {
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ video_idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>';
                return;
            }

            if (videoSegments.length === 0) {
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ ì €ì¥í•  ì„¸ê·¸ë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                return;
            }

            if (!videoTitle) {
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ ì œëª©ì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.</span>';
                return;
            }

            if (!videoRawSummary || videoRawSummary.trim() === '') {
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ ìš”ì•½ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.</span>';
                return;
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì €ì¥ ì¤‘ ë©”ì‹œì§€ í‘œì‹œ
            saveBtn.disabled = true;
            saveBtn.style.opacity = '0.6';
            saveBtn.style.cursor = 'not-allowed';
            statusDiv.innerHTML = '<span style="color: #666;">ğŸ’¾ VectorStoreì— ì €ì¥ì¤‘ì…ë‹ˆë‹¤...</span>';
            console.log('[Video] Saving to VectorStore with raw summary (citations preserved)');
            console.log('[Video] Summary length:', videoRawSummary ? videoRawSummary.length : 0);
            console.log('[Video] Summary preview:', videoRawSummary ? videoRawSummary.substring(0, 200) : 'EMPTY');

            try {
                const payload = {
                    source_id: videoId,
                    source_type: 'youtube',
                    segments: videoSegments,
                    title: videoTitle,
                    summary: videoRawSummary  // ì›ë³¸ ë§ˆí¬ë‹¤ìš´ ì‚¬ìš© (citation í¬í•¨)
                };
                console.log('[Video] Payload summary included:', !!payload.summary);

                const response = await fetch('/api/save-to-vectorstore', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = `<span style="color: #10b981;">âœ… ${data.message}</span>`;
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 5000);
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc2626;">âŒ ${data.error}</span>`;
                }
            } catch (error) {
                console.error('VectorStore ì €ì¥ ì˜¤ë¥˜:', error);
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ VectorStore ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>';
            } finally {
                // ë²„íŠ¼ ì¬í™œì„±í™”
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
            }
        });

        // ì˜ìƒ ë³€ê²½
        document.getElementById('changeVideoBtn').addEventListener('click', () => {
            if (confirm('í˜„ì¬ ì‘ì—…ì„ ì¢…ë£Œí•˜ê³  ìƒˆë¡œìš´ ì˜ìƒì„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ë·°ì–´ ì„¹ì…˜ ìˆ¨ê¸°ê³  ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
                document.getElementById('videoViewerSection').style.display = 'none';
                document.getElementById('videoUploadSection').style.display = 'block';
                document.getElementById('youtubeUrl').value = '';

                // ìš”ì•½ ì´ˆê¸°í™”
                document.getElementById('videoSummaryContent').innerHTML = '<p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>';

                // ì±„íŒ… ì´ˆê¸°í™”
                document.getElementById('videoChatMessages').innerHTML = `
                    <div class="chat-welcome">
                        íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                    </div>
                `;
                videoChatHistory = [];

                // íšŒì˜ë¡ ì´ˆê¸°í™”
                document.getElementById('videoTranscriptContent').innerHTML = '';
                videoSegments = [];
                videoSessionId = null;
                videoId = null;

                // YouTube Player ì •ë¦¬
                if (videoHighlightInterval) {
                    clearInterval(videoHighlightInterval);
                    videoHighlightInterval = null;
                }

                console.log('[Video] Session cleared. Ready for new video.');
            }
        });

        // ì˜ìƒ ìë™ ìŠ¤í¬ë¡¤ í† ê¸€
        document.getElementById('videoAutoScrollToggle').addEventListener('click', function() {
            videoAutoScrollEnabled = !videoAutoScrollEnabled;
            this.classList.toggle('active');
            this.textContent = videoAutoScrollEnabled ? 'ìë™ ìŠ¤í¬ë¡¤: ON' : 'ìë™ ìŠ¤í¬ë¡¤: OFF';
            console.log(`[Video] ìë™ ìŠ¤í¬ë¡¤ í† ê¸€: ${videoAutoScrollEnabled ? 'ON' : 'OFF'}`);
        });

        // YouTube í”Œë ˆì´ì–´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        let videoHighlightInterval = null;

        function onYouTubePlayerReady(event) {
            // í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ì—ˆì„ ë•Œ
        }

        function onYouTubePlayerStateChange(event) {
            // ì¬ìƒ ì¤‘ì¼ ë•Œë§Œ í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
            if (event.data === YT.PlayerState.PLAYING) {
                console.log('[Video] Player started playing. Starting highlight updates.');
                if (videoHighlightInterval) {
                    clearInterval(videoHighlightInterval);
                }
                videoHighlightInterval = setInterval(() => {
                    if (youtubePlayer && youtubePlayer.getCurrentTime) {
                        const currentTime = youtubePlayer.getCurrentTime();
                        console.log('[Video] Current time:', currentTime.toFixed(2), 's');
                        highlightCurrentVideoSegment(currentTime);
                    }
                }, 100); // 100msë§ˆë‹¤ ì—…ë°ì´íŠ¸
            } else {
                // ì¼ì‹œì •ì§€, ì •ì§€ ë“±
                console.log('[Video] Player paused/stopped. Stopping highlight updates.');
                if (videoHighlightInterval) {
                    clearInterval(videoHighlightInterval);
                    videoHighlightInterval = null;
                }
            }
        }

        // ì˜ìƒ ì¬ìƒ ì‹œê°„ì— ë”°ë¼ í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ í•˜ì´ë¼ì´íŠ¸
        function highlightCurrentVideoSegment(currentTime) {
            if (!videoSegments || videoSegments.length === 0) {
                console.warn('[Video Highlight] No video segments available');
                return;
            }

            // í˜„ì¬ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ì„¸ê·¸ë¨¼íŠ¸ ì°¾ê¸°
            let currentSegment = null;
            for (let i = 0; i < videoSegments.length; i++) {
                const segment = videoSegments[i];
                const nextSegment = videoSegments[i + 1];

                if (nextSegment) {
                    if (currentTime >= segment.start_time && currentTime < nextSegment.start_time) {
                        currentSegment = segment;
                        break;
                    }
                } else {
                    if (currentTime >= segment.start_time) {
                        currentSegment = segment;
                        break;
                    }
                }
            }

            if (currentSegment) {
                console.log('[Video Highlight] Found segment:', {
                    id: currentSegment.id,
                    speaker: currentSegment.speaker,
                    start_time: currentSegment.start_time
                });

                // ëª¨ë“  ì„¸ê·¸ë¨¼íŠ¸ì—ì„œ active-audio í´ë˜ìŠ¤ ì œê±°
                const allSegments = document.querySelectorAll('#videoTranscriptContent .transcript-segment');
                allSegments.forEach(seg => seg.classList.remove('active-audio'));

                // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ì— active-audio í´ë˜ìŠ¤ ì¶”ê°€
                const currentSegmentElement = document.querySelector(
                    `#videoTranscriptContent .transcript-segment[data-id="${currentSegment.id}"]`
                );

                if (currentSegmentElement) {
                    console.log('[Video Highlight] âœ… Adding active-audio to segment ID:', currentSegment.id);
                    currentSegmentElement.classList.add('active-audio');

                    // ìë™ ìŠ¤í¬ë¡¤ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ íšŒì˜ë¡ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œë§Œ ìŠ¤í¬ë¡¤
                    if (videoAutoScrollEnabled) {
                        const transcriptContainer = document.getElementById('videoTranscriptContent');

                        // ë” ì •í™•í•œ ìœ„ì¹˜ ê³„ì‚°ì„ ìœ„í•´ getBoundingClientRect ì‚¬ìš©
                        const containerRect = transcriptContainer.getBoundingClientRect();
                        const elementRect = currentSegmentElement.getBoundingClientRect();

                        // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ ìœ„ì¹˜ ê³„ì‚°
                        const relativeTop = elementRect.top - containerRect.top + transcriptContainer.scrollTop;
                        const containerHeight = transcriptContainer.clientHeight;
                        const elementHeight = currentSegmentElement.offsetHeight;

                        // ìš”ì†Œë¥¼ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ì— ìœ„ì¹˜ì‹œí‚¤ê¸°
                        const scrollTo = relativeTop - (containerHeight / 2) + (elementHeight / 2);

                        transcriptContainer.scrollTo({
                            top: scrollTo,
                            behavior: 'smooth'
                        });

                        console.log('[Video Highlight] Container height:', containerHeight, 'Element relative top:', relativeTop, 'Scrolling to:', scrollTo);
                    }
                } else {
                    console.error('[Video Highlight] âŒ Could not find segment element with data-id:', currentSegment.id);
                }
            }
        }

        // ========================================
        // ì˜¤ë””ì˜¤ ê²€ìƒ‰ íƒ­ ë¡œì§
        // ========================================

        // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­
        const fileUploadArea = document.getElementById('fileUploadArea');
        const audioFileInput = document.getElementById('audioFileInput');
        const fileInfo = document.getElementById('fileInfo');
        const audioSubmitBtn = document.getElementById('audioSubmitBtn');

        fileUploadArea.addEventListener('click', () => {
            audioFileInput.click();
        });

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('drag-over');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('drag-over');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        audioFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        function handleFileSelect(file) {
            selectedAudioFile = file;

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileType').textContent = file.type || 'ì•Œ ìˆ˜ ì—†ìŒ';
            fileInfo.classList.add('show');

            audioSubmitBtn.disabled = false;
        }

        // ì˜¤ë””ì˜¤ í¼ ì œì¶œ
        document.getElementById('audioForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedAudioFile) {
                alert('ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const formData = new FormData();
            formData.append('audio_file', selectedAudioFile);

            document.getElementById('audioUploadStatus').innerHTML = '<p style="color: #666;">ì²˜ë¦¬ ì¤‘...</p>';
            document.getElementById('audioProgressSection').style.display = 'block';
            audioSubmitBtn.disabled = true;
            audioSubmitBtn.innerHTML = '<span class="btn-icon">â³</span>ì˜¤ë””ì˜¤ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œì¤‘';

            try {
                const response = await fetch('/api/process-audio', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    if (data.cached) {
                        displayAudioResult(data);
                    } else if (data.processing) {
                        audioTaskId = data.task_id;
                        const estimatedTime = data.estimated_time || 60; // ê¸°ë³¸ê°’ 60ì´ˆ
                        startAudioProgressPolling(estimatedTime);
                    }
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                    document.getElementById('audioProgressSection').style.display = 'none';
                    audioSubmitBtn.disabled = false;
                    audioSubmitBtn.innerHTML = '<span class="btn-icon">ğŸ¤</span>ì˜¤ë””ì˜¤ ì²˜ë¦¬ ì‹œì‘';
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                document.getElementById('audioProgressSection').style.display = 'none';
                audioSubmitBtn.disabled = false;
                audioSubmitBtn.innerHTML = '<span class="btn-icon">ğŸ¤</span>ì˜¤ë””ì˜¤ ì²˜ë¦¬ ì‹œì‘';
            }
        });

        // ì˜¤ë””ì˜¤ ì§„í–‰ ìƒí™© í´ë§ (ì˜ˆìƒ ì‹œê°„ ê¸°ë°˜ í”„ë¡œê·¸ë ˆìŠ¤ ë°”)
        function startAudioProgressPolling(estimatedTime) {
            if (audioProgressInterval) {
                clearInterval(audioProgressInterval);
            }

            // ì˜ˆìƒ ì‹œê°„ ê¸°ë°˜ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
            const startTime = Date.now();
            const updateInterval = 200; // 200msë§ˆë‹¤ ì—…ë°ì´íŠ¸
            let simulatedProgress = 0;

            // ì‹œë®¬ë ˆì´ì…˜ íƒ€ì´ë¨¸ (í”„ë¡œê·¸ë ˆìŠ¤ ë°”ë¥¼ ë¶€ë“œëŸ½ê²Œ ì¦ê°€)
            const simulationInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000; // ê²½ê³¼ ì‹œê°„ (ì´ˆ)
                simulatedProgress = Math.min(95, (elapsed / estimatedTime) * 100); // ìµœëŒ€ 95%ê¹Œì§€ë§Œ

                updateAudioProgress('stt', Math.round(simulatedProgress), 'ì˜¤ë””ì˜¤ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œì¤‘...');
            }, updateInterval);

            // ì‹¤ì œ ì§„í–‰ ìƒí™© í´ë§ (ì„œë²„ì—ì„œ ì™„ë£Œ ì‹ í˜¸ í™•ì¸)
            audioProgressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/progress/${audioTaskId}`);
                    const data = await response.json();

                    if (data.success) {
                        const progress = data.progress;

                        // ì‹¤ì œ ì„œë²„ì—ì„œ ì§„í–‰ ìƒí™©ì´ ì˜¤ë©´ í•´ë‹¹ ê°’ ì‚¬ìš©
                        if (progress.stt && progress.stt.progress > 0) {
                            clearInterval(simulationInterval); // ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì§€
                            updateAudioProgress('stt', progress.stt.progress, progress.stt.message, progress.stt);
                        }

                        if (progress.vectorstore) {
                            updateAudioProgress('vectorstore', progress.vectorstore.progress, progress.vectorstore.message, progress.vectorstore);
                        }

                        if (progress.completed && progress.result) {
                            clearInterval(audioProgressInterval);
                            clearInterval(simulationInterval);
                            // ìµœì¢… ì‹œê°„ ì •ë³´ í‘œì‹œ
                            const finalMessage = progress.stt ? progress.stt.message : 'STT ì™„ë£Œ';
                            updateAudioProgress('stt', 100, finalMessage, progress.stt);
                            displayAudioResult(progress.result);
                        }

                        if (progress.error) {
                            clearInterval(audioProgressInterval);
                            clearInterval(simulationInterval);
                            alert('ì˜¤ë¥˜: ' + progress.error.message);
                            document.getElementById('audioProgressSection').style.display = 'none';
                            audioSubmitBtn.disabled = false;
                            audioSubmitBtn.innerHTML = '<span class="btn-icon">ğŸ¤</span>ì˜¤ë””ì˜¤ ì²˜ë¦¬ ì‹œì‘';
                        }
                    }
                } catch (error) {
                    console.error('ì§„í–‰ ìƒí™© ì¡°íšŒ ì˜¤ë¥˜:', error);
                }
            }, 1000);
        }

        function updateAudioProgress(type, percent, message, progressData = null) {
            const progressSpan = document.getElementById(`audio${type.charAt(0).toUpperCase() + type.slice(1)}Progress`);
            const progressBar = document.getElementById(`audio${type.charAt(0).toUpperCase() + type.slice(1)}ProgressBar`);
            const messageDiv = document.getElementById(`audio${type.charAt(0).toUpperCase() + type.slice(1)}Message`);

            if (progressSpan) progressSpan.textContent = `${percent}%`;
            if (progressBar) progressBar.style.width = `${percent}%`;

            // ì‹œê°„ ì •ë³´ í¬í•¨ ë©”ì‹œì§€ ìƒì„±
            if (messageDiv) {
                let fullMessage = message;

                if (progressData && (progressData.estimated_time || progressData.elapsed_time)) {
                    const timeInfo = [];

                    if (progressData.estimated_time !== undefined) {
                        timeInfo.push(`ì˜ˆìƒ: ${Math.round(progressData.estimated_time)}ì´ˆ`);
                    }

                    if (progressData.elapsed_time !== undefined) {
                        timeInfo.push(`ê²½ê³¼: ${Math.round(progressData.elapsed_time)}ì´ˆ`);
                    }

                    if (progressData.remaining_time !== undefined) {
                        timeInfo.push(`ë‚¨ìŒ: ${Math.round(progressData.remaining_time)}ì´ˆ`);
                    }

                    if (timeInfo.length > 0) {
                        fullMessage += ` (${timeInfo.join(', ')})`;
                    }
                }

                messageDiv.textContent = fullMessage;
            }
        }

        // ì˜¤ë””ì˜¤ ê²°ê³¼ í‘œì‹œ
        function displayAudioResult(data) {
            audioSessionId = data.session_id;
            audioFileHash = data.file_hash;  // íŒŒì¼ í•´ì‹œ ì €ì¥
            audioFilename = data.filename;  // ë°±ì—”ë“œì—ì„œ ë°˜í™˜ëœ ì‹¤ì œ íŒŒì¼ëª… ì €ì¥
            audioSegments = data.segments;

            // ì—…ë¡œë“œ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('audioUploadSection').style.display = 'none';
            document.getElementById('audioViewerSection').style.display = 'block';

            // ì˜¤ë””ì˜¤ ì •ë³´ í‘œì‹œ
            const audioDurationMin = Math.floor(data.audio_duration / 60);
            const audioDurationSec = Math.floor(data.audio_duration % 60);
            const audioDurationStr = `${audioDurationMin}ë¶„ ${audioDurationSec}ì´ˆ`;

            document.getElementById('audioContentInfo').innerHTML = `
                <div class="info-row">
                    <div class="info-item">
                        <strong>íŒŒì¼ëª…:</strong> <span>${data.filename}</span>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-item">
                        <strong>íŒŒì¼ í¬ê¸°:</strong> <span>${formatFileSize(data.file_size)}</span>
                    </div>
                    <div class="info-item">
                        <strong>ì˜¤ë””ì˜¤ ê¸¸ì´:</strong> <span>${audioDurationStr}</span>
                    </div>
                    <div class="info-item">
                        <strong>ì²˜ë¦¬ ì¼ì‹œ:</strong> <span>${data.created_at}</span>
                    </div>
                    <div class="info-item">
                        <strong>STT ì²˜ë¦¬ ì‹œê°„:</strong> <span>${data.stt_processing_time.toFixed(2)}ì´ˆ</span>
                    </div>
                </div>
            `;

            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì„¤ì •
            const audioPath = data.file_path.replace(/\\/g, '/');
            const audioUrl = `/uploads/${audioPath.split('/').pop()}`;

            audioElement = document.getElementById('audioPlayer');
            audioElement.src = audioUrl;

            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            if (audioTimeUpdateHandler) {
                audioElement.removeEventListener('timeupdate', audioTimeUpdateHandler);
            }

            // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì •ì˜
            audioTimeUpdateHandler = () => {
                const currentTime = audioElement.currentTime;
                console.log('[Audio] Current time:', currentTime.toFixed(2), 's');
                highlightCurrentAudioSegment(currentTime);
            };

            // ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œê°„ì— ë”°ë¼ ëŒ€í™” í•˜ì´ë¼ì´íŠ¸
            audioElement.addEventListener('timeupdate', audioTimeUpdateHandler);
            console.log('[Audio] Event listener attached. Total segments:', audioSegments.length);

            // íšŒì˜ë¡ í‘œì‹œ
            displayAudioTranscript(data.segments);

            // ìš”ì•½ ë¨¼ì € ì´ˆê¸°í™” (ë¬´ì¡°ê±´)
            audioRawSummary = '';  // ì›ë³¸ ë§ˆí¬ë‹¤ìš´ ì´ˆê¸°í™”
            document.getElementById('audioSummaryContent').innerHTML = '<p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>';

            // ìš”ì•½ì´ ìˆê³  ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ í‘œì‹œ
            if (data.summary && data.summary.trim() !== '') {
                audioRawSummary = data.summary;  // ìºì‹œëœ ì›ë³¸ ë§ˆí¬ë‹¤ìš´ ì €ì¥
                document.getElementById('audioSummaryContent').innerHTML = marked.parse(data.summary);
                console.log('[Audio] Loaded cached summary and raw markdown.');
            }

            // ì±„íŒ… ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì˜¤ë””ì˜¤ì´ë¯€ë¡œ)
            document.getElementById('audioChatMessages').innerHTML = `
                <div class="chat-welcome">
                    íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                </div>
            `;
            audioChatHistory = [];

            // ì§„í–‰ ìƒí™© ìˆ¨ê¸°ê¸°
            document.getElementById('audioProgressSection').style.display = 'none';
            audioSubmitBtn.disabled = false;
            audioSubmitBtn.innerHTML = '<span class="btn-icon">ğŸ¤</span>ì˜¤ë””ì˜¤ ì²˜ë¦¬ ì‹œì‘';

            console.log('[Audio] New audio loaded. Summary and chat initialized.');
        }

        // ì˜¤ë””ì˜¤ íšŒì˜ë¡ í‘œì‹œ
        // ì˜¤ë””ì˜¤ ì„¸ê·¸ë¨¼íŠ¸ ìë™ ì •ì§€ìš©
        let audioSegmentStopListener = null;

        function displayAudioTranscript(segments) {
            const transcriptContent = document.getElementById('audioTranscriptContent');
            transcriptContent.innerHTML = '';

            segments.forEach((segment, idx) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'transcript-segment';
                segmentDiv.dataset.time = segment.start_time;
                segmentDiv.dataset.id = segment.id;

                // end_time ê³„ì‚° (ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ì˜ start_time)
                const endTime = idx < segments.length - 1 ? segments[idx + 1].start_time : null;
                if (endTime) {
                    segmentDiv.dataset.endTime = endTime;
                }

                const minutes = Math.floor(segment.start_time / 60);
                const seconds = Math.floor(segment.start_time % 60);
                const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                // end_time í‘œì‹œ
                let timeRangeStr = timeStr;
                if (endTime) {
                    const endMinutes = Math.floor(endTime / 60);
                    const endSeconds = Math.floor(endTime % 60);
                    const endTimeStr = `${String(endMinutes).padStart(2, '0')}:${String(endSeconds).padStart(2, '0')}`;
                    timeRangeStr = `${timeStr} ~ ${endTimeStr}`;
                }

                segmentDiv.innerHTML = `
                    <div class="segment-header">
                        <span class="segment-speaker">í™”ì ${segment.speaker}</span>
                        <span class="segment-time">${timeRangeStr}</span>
                    </div>
                    <div class="segment-text">${segment.text}</div>
                `;

                segmentDiv.addEventListener('click', () => {
                    if (audioElement) {
                        // ê¸°ì¡´ listener ì œê±°
                        if (audioSegmentStopListener) {
                            audioElement.removeEventListener('timeupdate', audioSegmentStopListener);
                        }

                        console.log(`[Audio] ìë™ ìŠ¤í¬ë¡¤ ìƒíƒœ: ${audioAutoScrollEnabled ? 'ON' : 'OFF'}, endTime: ${endTime}`);

                        // ì‹œì‘ ìœ„ì¹˜ë¡œ ì´ë™ í›„ ì¬ìƒ
                        audioElement.currentTime = segment.start_time;
                        audioElement.play();

                        // ìë™ ìŠ¤í¬ë¡¤ OFFì´ê³  end_timeì´ ìˆìœ¼ë©´ ìë™ ì •ì§€ ì„¤ì •
                        if (!audioAutoScrollEnabled && endTime) {
                            console.log(`[Audio] ìë™ ì •ì§€ ì„¤ì •: ${segment.start_time}s ~ ${endTime}s`);
                            audioSegmentStopListener = function() {
                                if (audioElement.currentTime >= endTime) {
                                    audioElement.pause();
                                    console.log(`[Audio] Auto-stopped at ${endTime}s`);
                                }
                            };
                            audioElement.addEventListener('timeupdate', audioSegmentStopListener);
                        } else {
                            console.log(`[Audio] ì—°ì† ì¬ìƒ ëª¨ë“œ (ìë™ ì •ì§€ ì•ˆ í•¨)`);
                        }
                    }
                });

                transcriptContent.appendChild(segmentDiv);
            });

            document.getElementById('audioSegmentInfo').textContent = `ì´ ${segments.length}ê°œ ì„¸ê·¸ë¨¼íŠ¸`;
        }

        // ì˜¤ë””ì˜¤ ìš”ì•½ ìƒì„±
        let audioRawSummary = '';  // ì›ë³¸ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ ì €ì¥ìš©
        document.getElementById('audioGenerateSummaryBtn').addEventListener('click', async () => {
            document.getElementById('audioSummaryLoading').style.display = 'block';
            document.getElementById('audioSummaryContent').innerHTML = '';

            try {
                const response = await fetch('/api/summarize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        segments: audioSegments,
                        session_id: audioSessionId,
                        title: audioTitle  // ì €ì¥ëœ ì œëª©ì„ ìš”ì•½ ìƒì„± ì‹œ ì°¸ì¡°
                    })
                });

                const data = await response.json();

                if (data.success) {
                    audioRawSummary = data.summary;  // ì›ë³¸ ë§ˆí¬ë‹¤ìš´ ì €ì¥ (citation í¬í•¨)
                    document.getElementById('audioSummaryContent').innerHTML = marked.parse(data.summary);
                    console.log('[Audio] Raw summary saved for VectorStore');
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('audioSummaryLoading').style.display = 'none';
            }
        });

        // ì˜¤ë””ì˜¤ ì±„íŒ… ì „ì†¡
        document.getElementById('audioSendChatBtn').addEventListener('click', () => sendAudioChatMessage());
        document.getElementById('audioChatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAudioChatMessage();
            }
        });

        async function sendAudioChatMessage() {
            const chatInput = document.getElementById('audioChatInput');
            const message = chatInput.value.trim();

            if (!message) return;

            const chatMessages = document.getElementById('audioChatMessages');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message user-message';
            userMessageDiv.innerHTML = `<div class="message-content">${message}</div>`;
            chatMessages.appendChild(userMessageDiv);

            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            document.getElementById('audioChatLoading').style.display = 'block';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        segments: audioSegments,
                        session_id: audioSessionId,
                        chat_history: audioChatHistory
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = 'chat-message ai-message';
                    aiMessageDiv.innerHTML = `<div class="message-content">${marked.parse(data.response)}</div>`;
                    chatMessages.appendChild(aiMessageDiv);

                    audioChatHistory = data.chat_history;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ì±„íŒ… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('audioChatLoading').style.display = 'none';
            }
        }

        // ì˜¤ë””ì˜¤ ì±„íŒ… ì´ˆê¸°í™”
        document.getElementById('audioClearChatBtn').addEventListener('click', () => {
            if (confirm('ëŒ€í™” ë‚´ì—­ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('audioChatMessages').innerHTML = `
                    <div class="chat-welcome">
                        íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                    </div>
                `;
                audioChatHistory = [];
            }
        });

        // ì˜¤ë””ì˜¤ ì œëª© ì €ì¥
        document.getElementById('saveAudioTitleBtn').addEventListener('click', () => {
            const title = document.getElementById('audioTitleInput').value.trim();
            const statusDiv = document.getElementById('audioTitleStatus');

            if (!title) {
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>';
                return;
            }

            // ì œëª©ì„ ë³€ìˆ˜ì— ì €ì¥
            audioTitle = title;
            statusDiv.innerHTML = '<span style="color: #10b981;">âœ… ì œëª©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìš”ì•½ ìƒì„± ë° VectorStore ì €ì¥ ì‹œ ì‚¬ìš©ë©ë‹ˆë‹¤.</span>';

            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);

            console.log('[Audio] ì œëª© ì €ì¥ë¨:', audioTitle);
        });

        // Audio VectorStore ì €ì¥
        document.getElementById('saveAudioToVectorstoreBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('audioVectorstoreSaveStatus');
            const saveBtn = document.getElementById('saveAudioToVectorstoreBtn');

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!audioFileHash) {
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ file_hashë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>';
                return;
            }

            if (audioSegments.length === 0) {
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ ì €ì¥í•  ì„¸ê·¸ë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                return;
            }

            if (!audioTitle) {
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ ì œëª©ì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.</span>';
                return;
            }

            if (!audioRawSummary || audioRawSummary.trim() === '') {
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ ìš”ì•½ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.</span>';
                return;
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì €ì¥ ì¤‘ ë©”ì‹œì§€ í‘œì‹œ
            saveBtn.disabled = true;
            saveBtn.style.opacity = '0.6';
            saveBtn.style.cursor = 'not-allowed';
            statusDiv.innerHTML = '<span style="color: #666;">ğŸ’¾ VectorStoreì— ì €ì¥ì¤‘ì…ë‹ˆë‹¤...</span>';
            console.log('[Audio] Saving to VectorStore with raw summary (citations preserved)');
            console.log('[Audio] Summary length:', audioRawSummary ? audioRawSummary.length : 0);
            console.log('[Audio] Summary preview:', audioRawSummary ? audioRawSummary.substring(0, 200) : 'EMPTY');

            try {
                const payload = {
                    source_id: audioFileHash,
                    source_type: 'audio',
                    segments: audioSegments,
                    title: audioTitle,
                    summary: audioRawSummary,  // ì›ë³¸ ë§ˆí¬ë‹¤ìš´ ì‚¬ìš© (citation í¬í•¨)
                    filename: audioFilename  // ë°±ì—”ë“œì—ì„œ ë°˜í™˜ëœ ì‹¤ì œ íŒŒì¼ëª… ì‚¬ìš©
                };
                console.log('[Audio] Payload summary included:', !!payload.summary);

                const response = await fetch('/api/save-to-vectorstore', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = `<span style="color: #10b981;">âœ… ${data.message}</span>`;
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 5000);
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc2626;">âŒ ${data.error}</span>`;
                }
            } catch (error) {
                console.error('VectorStore ì €ì¥ ì˜¤ë¥˜:', error);
                statusDiv.innerHTML = '<span style="color: #dc2626;">âŒ VectorStore ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>';
            } finally {
                // ë²„íŠ¼ ì¬í™œì„±í™”
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
            }
        });

        // ì˜¤ë””ì˜¤ ë³€ê²½
        document.getElementById('changeAudioBtn').addEventListener('click', () => {
            if (confirm('í˜„ì¬ ì‘ì—…ì„ ì¢…ë£Œí•˜ê³  ìƒˆë¡œìš´ ì˜¤ë””ì˜¤ë¥¼ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ë·°ì–´ ì„¹ì…˜ ìˆ¨ê¸°ê³  ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
                document.getElementById('audioViewerSection').style.display = 'none';
                document.getElementById('audioUploadSection').style.display = 'block';
                selectedAudioFile = null;
                fileInfo.classList.remove('show');
                audioSubmitBtn.disabled = true;

                // ìš”ì•½ ì´ˆê¸°í™”
                document.getElementById('audioSummaryContent').innerHTML = '<p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>';

                // ì±„íŒ… ì´ˆê¸°í™”
                document.getElementById('audioChatMessages').innerHTML = `
                    <div class="chat-welcome">
                        íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                    </div>
                `;
                audioChatHistory = [];

                // íšŒì˜ë¡ ì´ˆê¸°í™”
                document.getElementById('audioTranscriptContent').innerHTML = '';
                audioSegments = [];
                audioSessionId = null;
                audioFileHash = null;
                audioFilename = null;

                // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì •ë¦¬
                if (audioElement) {
                    audioElement.pause();
                    audioElement.src = '';
                }

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
                if (audioTimeUpdateHandler) {
                    audioElement.removeEventListener('timeupdate', audioTimeUpdateHandler);
                    audioTimeUpdateHandler = null;
                }

                console.log('[Audio] Session cleared. Ready for new audio.');
            }
        });

        // ì˜¤ë””ì˜¤ ìë™ ìŠ¤í¬ë¡¤ í† ê¸€
        document.getElementById('audioAutoScrollToggle').addEventListener('click', function() {
            audioAutoScrollEnabled = !audioAutoScrollEnabled;
            this.classList.toggle('active');
            this.textContent = audioAutoScrollEnabled ? 'ìë™ ìŠ¤í¬ë¡¤: ON' : 'ìë™ ìŠ¤í¬ë¡¤: OFF';
            console.log(`[Audio] ìë™ ìŠ¤í¬ë¡¤ í† ê¸€: ${audioAutoScrollEnabled ? 'ON' : 'OFF'}`);
        });

        // ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œê°„ì— ë”°ë¼ í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ í•˜ì´ë¼ì´íŠ¸
        function highlightCurrentAudioSegment(currentTime) {
            if (!audioSegments || audioSegments.length === 0) {
                console.warn('[Audio Highlight] No audio segments available');
                return;
            }

            // í˜„ì¬ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ì„¸ê·¸ë¨¼íŠ¸ ì°¾ê¸°
            let currentSegment = null;
            for (let i = 0; i < audioSegments.length; i++) {
                const segment = audioSegments[i];
                const nextSegment = audioSegments[i + 1];

                if (nextSegment) {
                    // í˜„ì¬ ì‹œê°„ì´ ì´ ì„¸ê·¸ë¨¼íŠ¸ì™€ ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ ì‚¬ì´ì— ìˆëŠ”ì§€ í™•ì¸
                    if (currentTime >= segment.start_time && currentTime < nextSegment.start_time) {
                        currentSegment = segment;
                        break;
                    }
                } else {
                    // ë§ˆì§€ë§‰ ì„¸ê·¸ë¨¼íŠ¸
                    if (currentTime >= segment.start_time) {
                        currentSegment = segment;
                        break;
                    }
                }
            }

            if (currentSegment) {
                console.log('[Audio Highlight] Found segment:', {
                    id: currentSegment.id,
                    speaker: currentSegment.speaker,
                    start_time: currentSegment.start_time,
                    text: currentSegment.text.substring(0, 50) + '...'
                });

                // ëª¨ë“  ì„¸ê·¸ë¨¼íŠ¸ì—ì„œ active-audio í´ë˜ìŠ¤ ì œê±°
                const allSegments = document.querySelectorAll('#audioTranscriptContent .transcript-segment');
                console.log('[Audio Highlight] Removing active-audio from', allSegments.length, 'segments');
                allSegments.forEach(seg => seg.classList.remove('active-audio'));

                // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ì— active-audio í´ë˜ìŠ¤ ì¶”ê°€
                const currentSegmentElement = document.querySelector(
                    `#audioTranscriptContent .transcript-segment[data-id="${currentSegment.id}"]`
                );

                if (currentSegmentElement) {
                    console.log('[Audio Highlight] âœ… Adding active-audio to segment ID:', currentSegment.id);
                    currentSegmentElement.classList.add('active-audio');

                    // í´ë˜ìŠ¤ê°€ ì‹¤ì œë¡œ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    const hasClass = currentSegmentElement.classList.contains('active-audio');
                    console.log('[Audio Highlight] Class added successfully:', hasClass);

                    // í˜„ì¬ ì ìš©ëœ ìŠ¤íƒ€ì¼ í™•ì¸
                    const styles = window.getComputedStyle(currentSegmentElement);
                    console.log('[Audio Highlight] Background:', styles.background);
                    console.log('[Audio Highlight] Border-left:', styles.borderLeft);

                    // ìë™ ìŠ¤í¬ë¡¤ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ íšŒì˜ë¡ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œë§Œ ìŠ¤í¬ë¡¤
                    if (audioAutoScrollEnabled) {
                        const transcriptContainer = document.getElementById('audioTranscriptContent');

                        // ë” ì •í™•í•œ ìœ„ì¹˜ ê³„ì‚°ì„ ìœ„í•´ getBoundingClientRect ì‚¬ìš©
                        const containerRect = transcriptContainer.getBoundingClientRect();
                        const elementRect = currentSegmentElement.getBoundingClientRect();

                        // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ ìœ„ì¹˜ ê³„ì‚°
                        const relativeTop = elementRect.top - containerRect.top + transcriptContainer.scrollTop;
                        const containerHeight = transcriptContainer.clientHeight;
                        const elementHeight = currentSegmentElement.offsetHeight;

                        // ìš”ì†Œë¥¼ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ì— ìœ„ì¹˜ì‹œí‚¤ê¸°
                        const scrollTo = relativeTop - (containerHeight / 2) + (elementHeight / 2);

                        transcriptContainer.scrollTo({
                            top: scrollTo,
                            behavior: 'smooth'
                        });

                        console.log('[Audio Highlight] Container height:', containerHeight, 'Element relative top:', relativeTop, 'Scrolling to:', scrollTo);
                    }
                } else {
                    console.error('[Audio Highlight] âŒ Could not find segment element with data-id:', currentSegment.id);
                    // ëª¨ë“  ì„¸ê·¸ë¨¼íŠ¸ì˜ data-id ì¶œë ¥í•˜ì—¬ ë””ë²„ê¹…
                    const allIds = Array.from(allSegments).map(seg => seg.dataset.id);
                    console.log('[Audio Highlight] Available segment IDs:', allIds);
                }
            }
        }

        // ========================================
        // Retriever ê²€ìƒ‰ íƒ­ ë¡œì§
        // ========================================

        // Retriever í¼ ì œì¶œ
        document.getElementById('retrieverForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const query = document.getElementById('retrieverQuery').value.trim();
            const sourceType = document.querySelector('input[name="source_type"]:checked').value;
            const nResults = parseInt(document.getElementById('retrieverResults').value);

            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ìƒíƒœ ë³€ê²½
            document.getElementById('retrieverStatus').innerHTML = '<p style="color: #666;">ê²€ìƒ‰ ì¤‘...</p>';
            document.getElementById('retrieverResultsSection').style.display = 'none';

            try {
                const requestBody = {
                    query: query,
                    n_results: nResults
                };

                // source_typeì´ 'all'ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¶”ê°€
                if (sourceType !== 'all') {
                    requestBody.source_type = sourceType;
                }

                const response = await fetch('/api/retriever-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.success) {
                    displayRetrieverResults(data.results, query);
                    document.getElementById('retrieverStatus').innerHTML = '';
                } else {
                    document.getElementById('retrieverStatus').innerHTML = `<p style="color: #dc2626;">ì˜¤ë¥˜: ${data.error}</p>`;
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                document.getElementById('retrieverStatus').innerHTML = '<p style="color: #dc2626;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        });

        // Retriever ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displayRetrieverResults(results, query) {
            const resultsContent = document.getElementById('retrieverResultsContent');
            const resultInfo = document.getElementById('retrieverResultInfo');

            if (!results || results.length === 0) {
                resultsContent.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);"><p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                document.getElementById('retrieverResultsSection').style.display = 'block';
                resultInfo.textContent = 'ê²€ìƒ‰ ê²°ê³¼: 0ê°œ';
                return;
            }

            resultsContent.innerHTML = '';

            results.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'transcript-segment';
                resultDiv.style.marginBottom = '20px';
                resultDiv.style.borderLeft = '4px solid var(--primary-color)';

                const metadata = result.metadata;
                const sourceType = metadata.source_type;
                const distance = result.distance ? result.distance.toFixed(4) : 'N/A';

                // ìš”ì•½ ê²€ìƒ‰ ê²°ê³¼ì¸ ê²½ìš° (document_typeìœ¼ë¡œ ëª…ì‹œì  êµ¬ë¶„)
                if (metadata.document_type === 'summary') {
                    const sourceIcon = sourceType === 'youtube' ? 'ğŸ¬' : 'ğŸµ';
                    const sourceName = sourceType === 'youtube' ? 'YouTube' : 'Audio';
                    const sourceId = metadata.source_id;
                    const createdAt = metadata.created_at || 'N/A';
                    const filename = metadata.filename || '';

                    resultDiv.innerHTML = `
                        <div class="segment-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <span class="segment-speaker" style="background: var(--accent-color, #f59e0b); color: white; padding: 4px 12px; border-radius: 6px; font-weight: 600;">
                                    ğŸ“ ${sourceIcon} ${sourceName} ìš”ì•½
                                </span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                <span style="padding: 4px 8px; background: rgba(var(--primary-rgb), 0.1); border-radius: 4px;">
                                    ìœ ì‚¬ë„: ${distance}
                                </span>
                            </div>
                        </div>
                        <div class="segment-text" style="margin-bottom: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                            ${marked.parse(result.document)}
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); padding: 8px 12px; background: rgba(var(--primary-rgb), 0.05); border-radius: 6px;">
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <span><strong>Source ID:</strong> ${sourceId}</span>
                                <span><strong>ìƒì„±ì¼ì‹œ:</strong> ${createdAt}</span>
                                ${filename ? `<span><strong>íŒŒì¼ëª…:</strong> ${filename}</span>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // ì„¸ê·¸ë¨¼íŠ¸ ê²€ìƒ‰ ê²°ê³¼ì¸ ê²½ìš° (ê¸°ì¡´ ë¡œì§)
                    const sourceIcon = sourceType === 'youtube' ? 'ğŸ¬' : 'ğŸµ';
                    const sourceName = sourceType === 'youtube' ? 'YouTube' : 'Audio';
                    const sourceId = metadata.source_id;
                    const speaker = metadata.speaker;
                    const startTime = metadata.start_time;
                    const confidence = (metadata.confidence * 100).toFixed(1);
                    const filename = metadata.filename || '';

                    const minutes = Math.floor(startTime / 60);
                    const seconds = Math.floor(startTime % 60);
                    const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                    // end_time í¬ë§·íŒ…
                    let timeRangeStr = timeStr;
                    if (metadata.end_time) {
                        const endMinutes = Math.floor(metadata.end_time / 60);
                        const endSeconds = Math.floor(metadata.end_time % 60);
                        const endTimeStr = `${String(endMinutes).padStart(2, '0')}:${String(endSeconds).padStart(2, '0')}`;
                        timeRangeStr = `${timeStr} ~ ${endTimeStr}`;
                    }

                    resultDiv.innerHTML = `
                        <div class="segment-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <span class="segment-speaker" style="background: var(--primary-color); color: white; padding: 4px 12px; border-radius: 6px; font-weight: 600;">
                                    ${sourceIcon} ${sourceName} - í™”ì ${speaker}
                                </span>
                                <span class="segment-time" style="margin-left: 12px; padding: 4px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                    ${timeRangeStr}
                                </span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                <span style="padding: 4px 8px; background: rgba(var(--primary-rgb), 0.1); border-radius: 4px;">
                                    ìœ ì‚¬ë„: ${distance}
                                </span>
                            </div>
                        </div>
                        <div class="segment-text" style="margin-bottom: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; line-height: 1.6;">
                            ${result.document}
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); padding: 8px 12px; background: rgba(var(--primary-rgb), 0.05); border-radius: 6px;">
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <span><strong>Source ID:</strong> ${sourceId}</span>
                                <span><strong>Segment ID:</strong> ${metadata.segment_id}</span>
                                <span><strong>Start Time:</strong> ${timeStr}</span>
                                <span><strong>Confidence:</strong> ${confidence}%</span>
                                ${filename ? `<span><strong>íŒŒì¼ëª…:</strong> ${filename}</span>` : ''}
                            </div>
                        </div>
                        <div style="margin-top: 8px; padding: 8px 12px; background: rgba(var(--primary-rgb), 0.1); border-radius: 6px; text-align: center; font-size: 0.9rem; color: var(--primary-color); font-weight: 600;">
                            ğŸ§ í´ë¦­í•˜ì—¬ ì¬ìƒí•˜ê¸°
                        </div>
                    `;

                    // í´ë¦­ ì´ë²¤íŠ¸: ì˜¤ë””ì˜¤/ë¹„ë””ì˜¤ ì¬ìƒ (ì„¸ê·¸ë¨¼íŠ¸ë§Œ)
                    resultDiv.style.cursor = 'pointer';
                    const endTime = metadata.end_time || null;
                    resultDiv.addEventListener('click', () => {
                        playFromRetrieverResult(sourceType, sourceId, startTime, endTime, filename);
                    });
                }

                resultsContent.appendChild(resultDiv);
            });

            document.getElementById('retrieverResultsSection').style.display = 'block';
            resultInfo.textContent = `ê²€ìƒ‰ ê²°ê³¼: ${results.length}ê°œ`;
        }

        // Retriever ê²°ê³¼ì—ì„œ ì¬ìƒí•˜ê¸° (í˜„ì¬ íƒ­ì—ì„œ)
        let retrieverAudioStopListener = null;
        let retrieverYoutubeStopInterval = null;

        async function playFromRetrieverResult(sourceType, sourceId, startTime, endTime, filename) {
            // í”Œë ˆì´ì–´ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('retrieverPlayerSection').style.display = 'block';

            if (sourceType === 'audio') {
                // ì˜¤ë””ì˜¤ íŒŒì¼ ì¬ìƒ
                console.log(`[Retriever] Playing audio: ${filename} from ${startTime}s to ${endTime || 'end'}s`);

                // YouTube í”Œë ˆì´ì–´ ìˆ¨ê¸°ê³  ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ í‘œì‹œ
                document.getElementById('retrieverYoutubePlayerWrapper').style.display = 'none';
                document.getElementById('retrieverAudioPlayerWrapper').style.display = 'block';
                document.getElementById('retrieverPlayerTitle').innerHTML = 'ğŸµ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ (ì„¸ê·¸ë¨¼íŠ¸ ì¬ìƒ)';

                // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ê°€ì ¸ì˜¤ê¸°
                if (!retrieverAudioPlayer) {
                    retrieverAudioPlayer = document.getElementById('retrieverAudioPlayer');
                }

                // ê¸°ì¡´ stop listener ì œê±°
                if (retrieverAudioStopListener) {
                    retrieverAudioPlayer.removeEventListener('timeupdate', retrieverAudioStopListener);
                }

                // ì˜¤ë””ì˜¤ íŒŒì¼ ê²½ë¡œ êµ¬ì„± (filename ê¸°ë°˜)
                const audioUrl = `/uploads/${filename}`;

                // ì˜¤ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì •
                retrieverAudioPlayer.src = audioUrl;
                retrieverAudioPlayer.currentTime = startTime;

                // end_timeì´ ìˆìœ¼ë©´ ìë™ ì •ì§€ ì„¤ì •
                if (endTime) {
                    retrieverAudioStopListener = function() {
                        if (retrieverAudioPlayer.currentTime >= endTime) {
                            retrieverAudioPlayer.pause();
                            console.log(`[Retriever] Auto-stopped at ${endTime}s`);
                        }
                    };
                    retrieverAudioPlayer.addEventListener('timeupdate', retrieverAudioStopListener);
                }

                // ë¡œë“œ í›„ ì¬ìƒ
                retrieverAudioPlayer.addEventListener('loadedmetadata', function onLoaded() {
                    retrieverAudioPlayer.currentTime = startTime;
                    retrieverAudioPlayer.play();
                    retrieverAudioPlayer.removeEventListener('loadedmetadata', onLoaded);
                }, { once: true });

                retrieverAudioPlayer.load();

            } else if (sourceType === 'youtube') {
                // YouTube ì˜ìƒ ì¬ìƒ
                console.log(`[Retriever] Playing YouTube: ${sourceId} from ${startTime}s to ${endTime || 'end'}s`);

                // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ìˆ¨ê¸°ê³  YouTube í”Œë ˆì´ì–´ í‘œì‹œ
                document.getElementById('retrieverAudioPlayerWrapper').style.display = 'none';
                document.getElementById('retrieverYoutubePlayerWrapper').style.display = 'block';
                document.getElementById('retrieverPlayerTitle').innerHTML = 'ğŸ¬ YouTube í”Œë ˆì´ì–´ (ì„¸ê·¸ë¨¼íŠ¸ ì¬ìƒ)';

                // ê¸°ì¡´ stop interval ì œê±°
                if (retrieverYoutubeStopInterval) {
                    clearInterval(retrieverYoutubeStopInterval);
                }

                // YouTube Player ì´ˆê¸°í™” ë˜ëŠ” ë¹„ë””ì˜¤ ë¡œë“œ
                if (!retrieverYoutubePlayer) {
                    retrieverYoutubePlayer = new YT.Player('retrieverYoutubePlayer', {
                        videoId: sourceId,
                        width: '100%',
                        height: '400',
                        playerVars: {
                            'autoplay': 1,
                            'controls': 1,
                            'start': Math.floor(startTime)
                        },
                        events: {
                            'onReady': (event) => {
                                event.target.seekTo(startTime, true);
                                event.target.playVideo();

                                // end_timeì´ ìˆìœ¼ë©´ ìë™ ì •ì§€ ì„¤ì •
                                if (endTime) {
                                    retrieverYoutubeStopInterval = setInterval(() => {
                                        const currentTime = event.target.getCurrentTime();
                                        if (currentTime >= endTime) {
                                            event.target.pauseVideo();
                                            clearInterval(retrieverYoutubeStopInterval);
                                            console.log(`[Retriever] Auto-stopped at ${endTime}s`);
                                        }
                                    }, 100);
                                }
                            }
                        }
                    });
                } else {
                    retrieverYoutubePlayer.loadVideoById({
                        videoId: sourceId,
                        startSeconds: startTime
                    });
                    retrieverYoutubePlayer.playVideo();

                    // end_timeì´ ìˆìœ¼ë©´ ìë™ ì •ì§€ ì„¤ì •
                    if (endTime) {
                        retrieverYoutubeStopInterval = setInterval(() => {
                            const currentTime = retrieverYoutubePlayer.getCurrentTime();
                            if (currentTime >= endTime) {
                                retrieverYoutubePlayer.pauseVideo();
                                clearInterval(retrieverYoutubeStopInterval);
                                console.log(`[Retriever] Auto-stopped at ${endTime}s`);
                            }
                        }, 100);
                    }
                }
            }

            // í”Œë ˆì´ì–´ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            document.getElementById('retrieverPlayerSection').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Retriever í”Œë ˆì´ì–´ ë‹«ê¸°
        document.getElementById('retrieverClosePlayerBtn').addEventListener('click', () => {
            document.getElementById('retrieverPlayerSection').style.display = 'none';

            // ì˜¤ë””ì˜¤ ì •ì§€ ë° ë¦¬ìŠ¤ë„ˆ ì œê±°
            if (retrieverAudioPlayer) {
                retrieverAudioPlayer.pause();
                if (retrieverAudioStopListener) {
                    retrieverAudioPlayer.removeEventListener('timeupdate', retrieverAudioStopListener);
                    retrieverAudioStopListener = null;
                }
            }

            // YouTube ì •ì§€ ë° interval ì œê±°
            if (retrieverYoutubePlayer && retrieverYoutubePlayer.pauseVideo) {
                retrieverYoutubePlayer.pauseVideo();
            }
            if (retrieverYoutubeStopInterval) {
                clearInterval(retrieverYoutubeStopInterval);
                retrieverYoutubeStopInterval = null;
            }
        });

        // ========================================
        // ë‚´ìš© ì§ˆë¬¸ íƒ­ ë¡œì§
        // ========================================

        // ë‚´ìš© ì§ˆë¬¸ í¼ ì œì¶œ
        document.getElementById('askContentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const question = document.getElementById('contentQuestion').value.trim();
            const transcriptN = parseInt(document.getElementById('transcriptCount').value);
            const summaryN = parseInt(document.getElementById('summaryCount').value);

            if (!question) {
                alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° í…ìŠ¤íŠ¸ ë³€ê²½
            const askContentBtn = document.getElementById('askContentBtn');
            const askContentBtnText = document.getElementById('askContentBtnText');
            const originalBtnText = askContentBtnText.textContent;

            askContentBtn.disabled = true;
            askContentBtnText.textContent = 'ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤...';
            askContentBtn.style.opacity = '0.6';
            askContentBtn.style.cursor = 'not-allowed';

            // UI ìƒíƒœ ë³€ê²½
            document.getElementById('askContentStatus').innerHTML = '<p style="color: #666;">ğŸ¤” ìƒê° ì¤‘... (ê²€ìƒ‰ ë° ë‹µë³€ ìƒì„±)</p>';
            document.getElementById('askContentAnswerSection').style.display = 'none';

            try {
                const response = await fetch('/api/ask_content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        transcript_n: transcriptN,
                        summary_n: summaryN
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayAskContentAnswer(data);
                    document.getElementById('askContentStatus').innerHTML = '';
                } else {
                    document.getElementById('askContentStatus').innerHTML = `<p style="color: #dc2626;">ì˜¤ë¥˜: ${data.error}</p>`;
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                document.getElementById('askContentStatus').innerHTML = '<p style="color: #dc2626;">ì§ˆë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            } finally {
                // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                askContentBtn.disabled = false;
                askContentBtnText.textContent = originalBtnText;
                askContentBtn.style.opacity = '1';
                askContentBtn.style.cursor = 'pointer';
            }
        });

        // ë‹µë³€ í‘œì‹œ í•¨ìˆ˜
        function displayAskContentAnswer(data) {
            const answerSection = document.getElementById('askContentAnswerSection');
            const answerContent = document.getElementById('askContentAnswer');
            const resultInfo = document.getElementById('askContentResultInfo');
            const transcriptResults = document.getElementById('askContentTranscriptResults');
            const summaryResults = document.getElementById('askContentSummaryResults');

            // ë‹µë³€ í‘œì‹œ (ë§ˆí¬ë‹¤ìš´ ë Œë”ë§)
            answerContent.innerHTML = marked.parse(data.answer);

            // ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜ í‘œì‹œ
            resultInfo.textContent = `ê²€ìƒ‰: ìš”ì•½ ${data.summary_results_count}ê°œ, ì›ë¬¸ ì„¸ê·¸ë¨¼íŠ¸ ${data.transcript_results_count}ê°œ`;

            // ìš”ì•½ ê²€ìƒ‰ ê²°ê³¼ ë¨¼ì € í‘œì‹œ (Retriever ìŠ¤íƒ€ì¼)
            if (data.summary_results && data.summary_results.length > 0) {
                summaryResults.innerHTML = data.summary_results.map((result, index) => {
                    const metadata = result.metadata || {};
                    const subtopic = metadata.subtopic || 'ì „ì²´';
                    const sourceType = metadata.source_type || 'unknown';
                    const sourceIcon = sourceType === 'youtube' ? 'ğŸ¬' : 'ğŸµ';
                    const sourceName = sourceType === 'youtube' ? 'YouTube' : 'Audio';
                    const sourceId = metadata.source_id || 'Unknown';
                    const createdAt = metadata.created_at || 'N/A';
                    const distance = result.distance ? result.distance.toFixed(4) : 'N/A';
                    const filename = metadata.filename || '';

                    return `
                        <div class="transcript-segment" style="margin-bottom: 20px; border-left: 4px solid var(--primary-color); padding-left: 0;">
                            <div class="segment-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div>
                                    <span class="segment-speaker" style="background: var(--accent-color, #f59e0b); color: white; padding: 4px 12px; border-radius: 6px; font-weight: 600;">
                                        ğŸ“ ${sourceIcon} ${sourceName} ìš”ì•½
                                    </span>
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    <span style="padding: 4px 8px; background: rgba(var(--primary-rgb), 0.1); border-radius: 4px;">
                                        ìœ ì‚¬ë„: ${distance}
                                    </span>
                                </div>
                            </div>
                            <div class="segment-text" style="margin-bottom: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                                ${marked.parse(result.document || '')}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); padding: 8px 12px; background: rgba(var(--primary-rgb), 0.05); border-radius: 6px;">
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <span><strong>Source ID:</strong> ${sourceId}</span>
                                    <span><strong>ì†Œì£¼ì œ:</strong> ${subtopic}</span>
                                    <span><strong>ìƒì„±ì¼ì‹œ:</strong> ${createdAt}</span>
                                    ${filename ? `<span><strong>íŒŒì¼ëª…:</strong> ${filename}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                summaryResults.innerHTML = '<p style="padding: 15px; color: var(--text-secondary);">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            // ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ (Citation ê¸°ë°˜)
            if (data.transcript_results && data.transcript_results.length > 0) {
                transcriptResults.innerHTML = data.transcript_results.map((result, index) => {
                    const metadata = result.metadata || {};
                    const sourceType = metadata.source_type || 'unknown';
                    const sourceIcon = sourceType === 'youtube' ? 'ğŸ¬' : 'ğŸµ';
                    const sourceName = sourceType === 'youtube' ? 'YouTube' : 'Audio';
                    const sourceId = metadata.source_id || 'Unknown';
                    const speaker = metadata.speaker || 'Unknown';
                    const startTime = metadata.start_time || 0;
                    const confidence = metadata.confidence ? (metadata.confidence * 100).toFixed(1) : 'N/A';
                    const distance = result.distance ? result.distance.toFixed(4) : 'N/A';
                    const filename = metadata.filename || '';
                    const segmentId = metadata.segment_id || 'N/A';

                    const minutes = Math.floor(startTime / 60);
                    const seconds = Math.floor(startTime % 60);
                    const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                    // end_time í¬ë§·íŒ…
                    let timeRangeStr = timeStr;
                    if (metadata.end_time) {
                        const endMinutes = Math.floor(metadata.end_time / 60);
                        const endSeconds = Math.floor(metadata.end_time % 60);
                        const endTimeStr = `${String(endMinutes).padStart(2, '0')}:${String(endSeconds).padStart(2, '0')}`;
                        timeRangeStr = `${timeStr} ~ ${endTimeStr}`;
                    }

                    return `
                        <div class="transcript-segment" style="margin-bottom: 20px; border-left: 4px solid var(--primary-color); padding-left: 0;">
                            <div class="segment-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div>
                                    <span class="segment-speaker" style="background: var(--primary-color); color: white; padding: 4px 12px; border-radius: 6px; font-weight: 600;">
                                        ${sourceIcon} ${sourceName} - í™”ì ${speaker}
                                    </span>
                                    <span class="segment-time" style="margin-left: 12px; padding: 4px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                        ${timeRangeStr}
                                    </span>
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    <span style="padding: 4px 8px; background: rgba(var(--primary-rgb), 0.1); border-radius: 4px;">
                                        ìœ ì‚¬ë„: ${distance}
                                    </span>
                                </div>
                            </div>
                            <div class="segment-text" style="margin-bottom: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; line-height: 1.6;">
                                ${result.document || ''}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); padding: 8px 12px; background: rgba(var(--primary-rgb), 0.05); border-radius: 6px;">
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <span><strong>Source ID:</strong> ${sourceId}</span>
                                    <span><strong>Segment ID:</strong> ${segmentId}</span>
                                    <span><strong>Start Time:</strong> ${timeStr}</span>
                                    <span><strong>Confidence:</strong> ${confidence}%</span>
                                    ${filename ? `<span><strong>íŒŒì¼ëª…:</strong> ${filename}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                transcriptResults.innerHTML = '<p style="padding: 15px; color: var(--text-secondary);">ì¸ìš©ëœ ì›ë¬¸ ì„¸ê·¸ë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            // ë‹µë³€ ì„¹ì…˜ í‘œì‹œ
            answerSection.style.display = 'block';

            // ìŠ¤í¬ë¡¤ ì´ë™
            answerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ========== ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ ==========

        // ë°ì´í„° ëª©ë¡ ë¡œë“œ
        async function loadDataList() {
            try {
                const response = await fetch('/api/data-management/list');
                const data = await response.json();

                if (data.success) {
                    // í†µê³„ í‘œì‹œ
                    displayStats(data.stats);

                    // YouTube ëª©ë¡ í‘œì‹œ
                    displayYoutubeList(data.youtube);

                    // ì˜¤ë””ì˜¤ ëª©ë¡ í‘œì‹œ
                    displayAudioList(data.audio);
                } else {
                    alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + data.error);
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í†µê³„ í‘œì‹œ
        function displayStats(stats) {
            const statsDiv = document.getElementById('dbStats');
            statsDiv.innerHTML = `
                <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">YouTube ì˜ìƒ</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary);">${stats.youtube_videos}ê°œ</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 5px;">ì„¸ê·¸ë¨¼íŠ¸: ${stats.youtube_segments.toLocaleString()}ê°œ</div>
                </div>
                <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid #2196F3;">
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">ì˜¤ë””ì˜¤ íŒŒì¼</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary);">${stats.audio_files}ê°œ</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 5px;">ì„¸ê·¸ë¨¼íŠ¸: ${stats.audio_segments.toLocaleString()}ê°œ</div>
                </div>
            `;
        }

        // YouTube ëª©ë¡ í‘œì‹œ
        function displayYoutubeList(youtubeList) {
            const listDiv = document.getElementById('youtubeList');

            if (youtubeList.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">ì €ì¥ëœ YouTube ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            listDiv.innerHTML = youtubeList.map(item => `
                <div style="padding: 15px; margin-bottom: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid #FF0000;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;">${item.title}</div>
                            <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px;">
                                ğŸ“º ${item.channel} | ì¡°íšŒìˆ˜: ${item.view_count.toLocaleString()}íšŒ | ì—…ë¡œë“œ: ${item.upload_date}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                ğŸ¤ ì„¸ê·¸ë¨¼íŠ¸: ${item.segments_count}ê°œ |
                                â±ï¸ STT: ${item.stt_time.toFixed(1)}ì´ˆ (${item.stt_service}) |
                                ğŸ“… ì²˜ë¦¬ì¼: ${item.created_at}
                                ${item.has_summary ? ' | âœ… ìš”ì•½ ìˆìŒ' : ''}
                            </div>
                        </div>
                        <button onclick="deleteData('youtube', '${item.id}')"
                                style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ì˜¤ë””ì˜¤ ëª©ë¡ í‘œì‹œ
        function displayAudioList(audioList) {
            const listDiv = document.getElementById('audioList');

            if (audioList.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">ì €ì¥ëœ ì˜¤ë””ì˜¤ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            listDiv.innerHTML = audioList.map(item => `
                <div style="padding: 15px; margin-bottom: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid #2196F3;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;">${item.filename}</div>
                            <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px;">
                                ğŸ“ ${item.file_path} | í¬ê¸°: ${formatFileSize(item.file_size)} | ê¸¸ì´: ${(item.duration / 60).toFixed(1)}ë¶„
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                ğŸ¤ ì„¸ê·¸ë¨¼íŠ¸: ${item.segments_count}ê°œ |
                                â±ï¸ STT: ${item.stt_time.toFixed(1)}ì´ˆ (${item.stt_service}) |
                                ğŸ“… ì²˜ë¦¬ì¼: ${item.created_at}
                                ${item.has_summary ? ' | âœ… ìš”ì•½ ìˆìŒ' : ''}
                            </div>
                        </div>
                        <button onclick="deleteData('audio', '${item.id}')"
                                style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ë°ì´í„° ì‚­ì œ
        async function deleteData(type, id) {
            const typeName = type === 'youtube' ? 'YouTube ì˜ìƒ' : 'ì˜¤ë””ì˜¤ íŒŒì¼';

            if (!confirm(`ì •ë§ë¡œ ì´ ${typeName}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const response = await fetch('/api/data-management/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type, id })
                });

                const data = await response.json();

                if (data.success) {
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadDataList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
                }
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë°ì´í„° ê´€ë¦¬ íƒ­ ì§„ì… ì‹œ ìë™ ë¡œë“œ
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                if (tabId === 'data-management-tab') {
                    loadDataList();
                }
            });
        });

        // Marked.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        document.head.appendChild(script);
    </script>
</body>
</html>
