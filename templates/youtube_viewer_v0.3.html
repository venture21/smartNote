<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ ì˜ìƒ/ì˜¤ë””ì˜¤ ê²€ìƒ‰ ì—”ì§„ v0.2</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- YouTube IFrame Player API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: var(--primary-color);
            background: rgba(var(--primary-rgb), 0.05);
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ì˜¤ë””ì˜¤ ì—…ë¡œë“œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgb), 0.05);
        }

        .file-upload-area.drag-over {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgb), 0.1);
        }

        .file-upload-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .file-upload-text {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .file-upload-hint {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .file-info {
            display: none;
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .file-info.show {
            display: block;
        }

        .file-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .file-info-item:last-child {
            margin-bottom: 0;
        }

        /* ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
        .audio-player-wrapper {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .audio-player-wrapper audio {
            width: 100%;
            height: 54px;
        }

        /* ì˜¤ë””ì˜¤ íƒ­ ì „ìš© ë ˆì´ì•„ì›ƒ - í”Œë ˆì´ì–´ ì—†ì´ ê°„ê²°í•˜ê²Œ */
        .audio-viewer-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            align-items: start;
            height: 800px; /* ëª…í™•í•œ ë†’ì´ ì„¤ì • */
        }

        .audio-left-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
        }

        /* ì˜¤ë””ì˜¤ íƒ­ì˜ íšŒì˜ë¡ ì»¨í…Œì´ë„ˆê°€ ì™¼ìª½(ìš”ì•½+ì±„íŒ…)ê³¼ ê°™ì€ ë†’ì´ ì‚¬ìš© */
        .audio-viewer-layout .transcript-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 800px;
        }

        .audio-viewer-layout .transcript-header {
            flex-shrink: 0; /* í—¤ë”ëŠ” ê³ ì • í¬ê¸° */
        }

        .audio-viewer-layout .transcript-content {
            flex: 1;
            overflow-y: auto !important;
            overflow-x: hidden;
            min-height: 0;
            height: auto !important;
            max-height: calc(800px - 80px); /* ì „ì²´ ë†’ì´ - í—¤ë” ë†’ì´ */
        }

        /* ìš”ì•½ê³¼ ì±„íŒ… ì»¨í…Œì´ë„ˆë„ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
        .audio-viewer-layout .summary-container,
        .audio-viewer-layout .chat-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .audio-viewer-layout .summary-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .audio-viewer-layout .chat-messages {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* ì˜¤ë””ì˜¤/ì˜ìƒ ì¬ìƒ ì¤‘ í˜„ì¬ ëŒ€í™” í•˜ì´ë¼ì´íŠ¸ */
        .transcript-segment.active-audio {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.3) 0%, rgba(59, 130, 246, 0.15) 100%) !important;
            border-left: 6px solid #2563eb !important;
            padding-left: 15px !important;
            margin-left: -10px !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
            transform: scale(1.02) !important;
        }

        .transcript-segment.active-audio .segment-header {
            color: #1d4ed8 !important;
            font-weight: 700 !important;
        }

        .transcript-segment.active-audio .segment-time {
            color: #2563eb !important;
            font-weight: 700 !important;
            background: rgba(59, 130, 246, 0.15);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 968px) {
            /* ì˜¤ë””ì˜¤ ë·°ì–´ ë ˆì´ì•„ì›ƒì„ ì„¸ë¡œë¡œ ë³€ê²½ */
            .audio-viewer-layout {
                display: flex !important;
                flex-direction: column !important;
                height: auto !important;
                gap: 20px;
            }

            .audio-viewer-layout .transcript-container {
                height: auto !important;
                max-height: 600px !important;
                order: 1; /* íšŒì˜ë¡ì„ ë§¨ ìœ„ë¡œ */
            }

            .audio-left-section {
                order: 2; /* ìš”ì•½+ì±„íŒ…ì„ ì•„ë˜ë¡œ */
            }

            .audio-viewer-layout .transcript-content {
                max-height: 500px !important;
            }

            .audio-viewer-layout .summary-container,
            .audio-viewer-layout .chat-container {
                height: 400px !important;
            }
        }

        @media (max-width: 768px) {
            /* ëª¨ë°”ì¼ ìµœì í™” */
            .audio-viewer-layout {
                display: flex !important;
                flex-direction: column !important;
                height: auto !important;
            }

            .audio-viewer-layout .transcript-container {
                height: auto !important;
                max-height: 500px !important;
                order: 1; /* íšŒì˜ë¡ì„ ë§¨ ìœ„ë¡œ */
            }

            .audio-left-section {
                order: 2; /* ìš”ì•½+ì±„íŒ…ì„ ì•„ë˜ë¡œ */
            }

            .audio-viewer-layout .transcript-content {
                max-height: 400px !important;
            }

            .audio-viewer-layout .summary-container,
            .audio-viewer-layout .chat-container {
                height: 350px !important;
            }

            /* ì˜¤ë””ì˜¤ ì •ë³´ ìµœì í™” */
            .video-info {
                font-size: 0.85rem !important;
                padding: 15px !important;
            }

            .info-row {
                flex-direction: column !important;
                gap: 8px !important;
            }
        }

        @media (max-width: 480px) {
            /* ì†Œí˜• ëª¨ë°”ì¼ */
            .audio-viewer-layout .transcript-container {
                max-height: 400px !important;
            }

            .audio-viewer-layout .transcript-content {
                max-height: 350px !important;
            }

            .audio-viewer-layout .summary-container,
            .audio-viewer-layout .chat-container {
                height: 300px !important;
            }

            /* ì„¸ê·¸ë¨¼íŠ¸ í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
            .transcript-segment {
                padding: 10px !important;
                font-size: 0.9rem !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header>
            <h1><span class="film-icon">ğŸ¬</span> ì˜ìƒ/ì˜¤ë””ì˜¤ ê²€ìƒ‰ ì—”ì§„ v0.2</h1>
        </header>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tabs">
            <button class="tab-button active" data-tab="video-tab">
                ğŸ¬ ì˜ìƒ ê²€ìƒ‰
            </button>
            <button class="tab-button" data-tab="audio-tab">
                ğŸµ ì˜¤ë””ì˜¤ ê²€ìƒ‰
            </button>
        </div>

        <!-- ========== ì˜ìƒ ê²€ìƒ‰ íƒ­ ========== -->
        <div id="video-tab" class="tab-content active">
            <!-- YouTube URL ì…ë ¥ ì„¹ì…˜ -->
            <section class="upload-section" id="videoUploadSection">
                <div class="upload-card">
                    <h2>ğŸ”— YouTube URL ì…ë ¥</h2>
                    <p class="description">YouTube ì˜ìƒ URLì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì—¬ íšŒì˜ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤</p>

                    <form id="youtubeForm">
                        <div class="form-group">
                            <label for="youtubeUrl">YouTube URL</label>
                            <input
                                type="text"
                                id="youtubeUrl"
                                name="youtube_url"
                                placeholder="https://www.youtube.com/watch?v=..."
                                required
                                style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;"
                            >
                        </div>

                        <div class="form-group">
                            <label>STT ì„œë¹„ìŠ¤ ì„ íƒ</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="video_stt_service" value="clova">
                                    <span class="radio-text">
                                        <strong>Clova STT</strong>
                                        <small>ë„¤ì´ë²„ í´ë¡œë°” (í•œêµ­ì–´ íŠ¹í™”, ë¹ ë¥¸ ì²˜ë¦¬)</small>
                                    </span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="video_stt_service" value="gemini" checked>
                                    <span class="radio-text">
                                        <strong>Gemini STT</strong>
                                        <small>êµ¬ê¸€ ì œë¯¸ë‚˜ì´ (ìµœì‹  AI, ì»¨í…ìŠ¤íŠ¸ ì´í•´)</small>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary">
                            <span class="btn-icon">ğŸ¤</span>
                            ì˜ìƒ ì²˜ë¦¬ ì‹œì‘
                        </button>
                    </form>

                    <div id="videoUploadStatus" class="upload-status"></div>

                    <!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
                    <div id="videoProgressSection" class="progress-section" style="display: none;">
                        <div class="progress-item">
                            <div class="progress-label">
                                <span>ğŸµ ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ & MP3 ë³€í™˜</span>
                                <span id="videoDownloadProgress">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="videoDownloadProgressBar" class="progress-fill"></div>
                            </div>
                            <div id="videoDownloadMessage" class="progress-message">ëŒ€ê¸° ì¤‘...</div>
                        </div>

                        <div class="progress-item">
                            <div class="progress-label">
                                <span>ğŸ¤ íšŒì˜ë¡ ìƒì„± (STT)</span>
                                <span id="videoSttProgress">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="videoSttProgressBar" class="progress-fill"></div>
                            </div>
                            <div id="videoSttMessage" class="progress-message">ëŒ€ê¸° ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ì˜ìƒ ë·°ì–´ ì„¹ì…˜ -->
            <section class="viewer-section" id="videoViewerSection" style="display: none;">
                <!-- ì˜ìƒ ì •ë³´ -->
                <div class="audio-player-container">
                    <div class="audio-header">
                        <h2>ğŸ“¹ ì˜ìƒ ì •ë³´</h2>
                        <button id="changeVideoBtn" class="btn-change-file" title="ë‹¤ë¥¸ ì˜ìƒ ì²˜ë¦¬">
                            ğŸ”— URL ë³€ê²½
                        </button>
                    </div>
                    <div class="video-info" id="videoInfo"></div>
                </div>

                <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ: í”Œë ˆì´ì–´+ìš”ì•½/ì±„íŒ… (ì™¼ìª½ 67%) | íšŒì˜ë¡ (ì˜¤ë¥¸ìª½ 33%) -->
                <div class="main-layout-grid">
                    <!-- ì™¼ìª½ ì˜ì—­: YouTube í”Œë ˆì´ì–´ + ìš”ì•½/ì±„íŒ… -->
                    <div class="left-section">
                        <!-- YouTube í”Œë ˆì´ì–´ -->
                        <div class="youtube-player-container">
                            <div class="audio-header">
                                <h2>ğŸ¬ YouTube í”Œë ˆì´ì–´</h2>
                            </div>
                            <div id="youtubePlayerWrapper">
                                <div id="youtubePlayer"></div>
                            </div>
                            <div class="player-info">
                                <span id="videoCurrentTime">00:00</span> / <span id="videoDuration">00:00</span>
                            </div>
                        </div>

                        <!-- ìš”ì•½ ë° ì±„íŒ… ì˜ì—­ -->
                        <div class="bottom-content-grid">
                            <!-- ìš”ì•½ ì„¹ì…˜ -->
                            <div class="summary-container">
                                <div class="summary-header">
                                    <h2>ğŸ“‹ íšŒì˜ë¡ ìš”ì•½</h2>
                                    <button id="videoGenerateSummaryBtn" class="btn-primary">ìš”ì•½ ìƒì„±</button>
                                </div>
                                <div id="videoSummaryContent" class="summary-content">
                                    <p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                                </div>
                                <div id="videoSummaryLoading" class="loading-indicator" style="display: none;">
                                    <span class="spinner"></span> ìš”ì•½ ìƒì„± ì¤‘...
                                </div>
                            </div>

                            <!-- ì±„íŒ… ì„¹ì…˜ -->
                            <div class="chat-container">
                                <div class="chat-header">
                                    <h2>ğŸ’¬ AI ì±„íŒ…</h2>
                                    <button id="videoClearChatBtn" class="btn-clear-chat" title="ëŒ€í™” ì´ˆê¸°í™”">ğŸ—‘ï¸</button>
                                </div>
                                <div id="videoChatMessages" class="chat-messages">
                                    <div class="chat-welcome">
                                        íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                                    </div>
                                </div>
                                <div class="chat-input-container">
                                    <textarea
                                        id="videoChatInput"
                                        class="chat-input"
                                        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                        rows="2"
                                    ></textarea>
                                    <button id="videoSendChatBtn" class="btn-send-chat">
                                        <img src="{{ url_for('static', filename='images/chat_icon.png') }}?v=2" alt="Send" class="btn-icon-img">
                                    </button>
                                </div>
                                <div id="videoChatLoading" class="loading-indicator" style="display: none;">
                                    <span class="spinner"></span> ì‘ë‹µ ìƒì„± ì¤‘...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½ ì˜ì—­: íšŒì˜ë¡ (33%) -->
                    <div class="right-section">
                        <div class="transcript-container">
                            <div class="transcript-header">
                                <h2>ğŸ“ íšŒì˜ë¡</h2>
                                <div class="controls">
                                    <button id="videoAutoScrollToggle" class="btn-secondary active">ìë™ ìŠ¤í¬ë¡¤: ON</button>
                                    <span id="videoSegmentInfo">ì´ 0ê°œ ì„¸ê·¸ë¨¼íŠ¸</span>
                                </div>
                            </div>
                            <div id="videoTranscriptContent" class="transcript-content"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- ========== ì˜¤ë””ì˜¤ ê²€ìƒ‰ íƒ­ ========== -->
        <div id="audio-tab" class="tab-content">
            <!-- ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <section class="upload-section" id="audioUploadSection">
                <div class="upload-card">
                    <h2>ğŸ“ ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ</h2>
                    <p class="description">ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ íšŒì˜ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤</p>

                    <form id="audioForm">
                        <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="file-upload-icon">ğŸ“</div>
                            <div class="file-upload-text">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
                            <div class="file-upload-hint">ì§€ì› í˜•ì‹: MP3, WAV, M4A, FLAC, OGG (ìµœëŒ€ 500MB)</div>
                            <input type="file" id="audioFileInput" accept="audio/*,video/*" style="display: none;">
                        </div>

                        <!-- ì„ íƒëœ íŒŒì¼ ì •ë³´ -->
                        <div class="file-info" id="fileInfo">
                            <div class="file-info-item">
                                <strong>íŒŒì¼ëª…:</strong>
                                <span id="fileName">-</span>
                            </div>
                            <div class="file-info-item">
                                <strong>íŒŒì¼ í¬ê¸°:</strong>
                                <span id="fileSize">-</span>
                            </div>
                            <div class="file-info-item">
                                <strong>íŒŒì¼ í˜•ì‹:</strong>
                                <span id="fileType">-</span>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label>STT ì„œë¹„ìŠ¤ ì„ íƒ</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="audio_stt_service" value="clova">
                                    <span class="radio-text">
                                        <strong>Clova STT</strong>
                                        <small>ë„¤ì´ë²„ í´ë¡œë°” (í•œêµ­ì–´ íŠ¹í™”, ë¹ ë¥¸ ì²˜ë¦¬)</small>
                                    </span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="audio_stt_service" value="gemini" checked>
                                    <span class="radio-text">
                                        <strong>Gemini STT</strong>
                                        <small>êµ¬ê¸€ ì œë¯¸ë‚˜ì´ (ìµœì‹  AI, ì»¨í…ìŠ¤íŠ¸ ì´í•´)</small>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary" id="audioSubmitBtn" disabled>
                            <span class="btn-icon">ğŸ¤</span>
                            ì˜¤ë””ì˜¤ ì²˜ë¦¬ ì‹œì‘
                        </button>
                    </form>

                    <div id="audioUploadStatus" class="upload-status"></div>

                    <!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
                    <div id="audioProgressSection" class="progress-section" style="display: none;">
                        <div class="progress-item">
                            <div class="progress-label">
                                <span>ğŸ¤ íšŒì˜ë¡ ìƒì„± (STT)</span>
                                <span id="audioSttProgress">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="audioSttProgressBar" class="progress-fill"></div>
                            </div>
                            <div id="audioSttMessage" class="progress-message">ëŒ€ê¸° ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ì˜¤ë””ì˜¤ ë·°ì–´ ì„¹ì…˜ -->
            <section class="viewer-section" id="audioViewerSection" style="display: none;">
                <!-- ì˜¤ë””ì˜¤ ì •ë³´ -->
                <div class="audio-player-container">
                    <div class="audio-header">
                        <h2>ğŸµ ì˜¤ë””ì˜¤ ì •ë³´</h2>
                        <button id="changeAudioBtn" class="btn-change-file" title="ë‹¤ë¥¸ ì˜¤ë””ì˜¤ ì—…ë¡œë“œ">
                            ğŸ“ íŒŒì¼ ë³€ê²½
                        </button>
                    </div>
                    <div class="video-info" id="audioContentInfo"></div>
                </div>

                <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
                <div class="audio-player-container">
                    <div class="audio-header">
                        <h2>ğŸµ ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´</h2>
                    </div>
                    <div class="audio-player-wrapper">
                        <audio id="audioPlayer" controls style="width: 100%;">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                </div>

                <!-- ì˜¤ë””ì˜¤ ì „ìš© ë ˆì´ì•„ì›ƒ: ìš”ì•½/ì±„íŒ… (ì™¼ìª½) | íšŒì˜ë¡ (ì˜¤ë¥¸ìª½) -->
                <div class="audio-viewer-layout">
                    <!-- ì™¼ìª½: ìš”ì•½ + ì±„íŒ… -->
                    <div class="audio-left-section">
                        <!-- ìš”ì•½ ì„¹ì…˜ -->
                        <div class="summary-container">
                            <div class="summary-header">
                                <h2>ğŸ“‹ íšŒì˜ë¡ ìš”ì•½</h2>
                                <button id="audioGenerateSummaryBtn" class="btn-primary">ìš”ì•½ ìƒì„±</button>
                            </div>
                            <div id="audioSummaryContent" class="summary-content">
                                <p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                            </div>
                            <div id="audioSummaryLoading" class="loading-indicator" style="display: none;">
                                <span class="spinner"></span> ìš”ì•½ ìƒì„± ì¤‘...
                            </div>
                        </div>

                        <!-- ì±„íŒ… ì„¹ì…˜ -->
                        <div class="chat-container">
                            <div class="chat-header">
                                <h2>ğŸ’¬ AI ì±„íŒ…</h2>
                                <button id="audioClearChatBtn" class="btn-clear-chat" title="ëŒ€í™” ì´ˆê¸°í™”">ğŸ—‘ï¸</button>
                            </div>
                            <div id="audioChatMessages" class="chat-messages">
                                <div class="chat-welcome">
                                    íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <textarea
                                    id="audioChatInput"
                                    class="chat-input"
                                    placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                    rows="2"
                                ></textarea>
                                <button id="audioSendChatBtn" class="btn-send-chat">
                                    <img src="{{ url_for('static', filename='images/chat_icon.png') }}?v=2" alt="Send" class="btn-icon-img">
                                </button>
                            </div>
                            <div id="audioChatLoading" class="loading-indicator" style="display: none;">
                                <span class="spinner"></span> ì‘ë‹µ ìƒì„± ì¤‘...
                            </div>
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½: íšŒì˜ë¡ -->
                    <div class="transcript-container">
                        <div class="transcript-header">
                            <h2>ğŸ“ íšŒì˜ë¡</h2>
                            <div class="controls">
                                <button id="audioAutoScrollToggle" class="btn-secondary active">ìë™ ìŠ¤í¬ë¡¤: ON</button>
                                <span id="audioSegmentInfo">ì´ 0ê°œ ì„¸ê·¸ë¨¼íŠ¸</span>
                            </div>
                        </div>
                        <div id="audioTranscriptContent" class="transcript-content"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // ========== ì˜ìƒ ê²€ìƒ‰ íƒ­ ì „ì—­ ë³€ìˆ˜ ==========
        let videoSessionId = null;
        let videoId = null;
        let videoSegments = [];
        let videoChatHistory = [];
        let youtubePlayer = null;
        let videoAutoScrollEnabled = true;
        let videoTaskId = null;
        let videoProgressInterval = null;

        // ========== ì˜¤ë””ì˜¤ ê²€ìƒ‰ íƒ­ ì „ì—­ ë³€ìˆ˜ ==========
        let audioSessionId = null;
        let audioSegments = [];
        let audioChatHistory = [];
        let audioElement = null;
        let audioAutoScrollEnabled = true;
        let audioTaskId = null;
        let audioProgressInterval = null;
        let selectedAudioFile = null;
        let audioTimeUpdateHandler = null;  // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì°¸ì¡° ì €ì¥

        // ========== ê³µí†µ í•¨ìˆ˜ ==========
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ========== íƒ­ ì „í™˜ ==========
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;

                // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                // ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¹€
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // ì„ íƒëœ íƒ­ í™œì„±í™”
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // ========================================
        // ì˜ìƒ ê²€ìƒ‰ íƒ­ ë¡œì§
        // ========================================

        // YouTube í¼ ì œì¶œ
        document.getElementById('youtubeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const youtubeUrl = document.getElementById('youtubeUrl').value.trim();
            const sttService = document.querySelector('input[name="video_stt_service"]:checked').value;

            if (!youtubeUrl) {
                alert('YouTube URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ìƒíƒœ ë³€ê²½
            document.getElementById('videoUploadStatus').innerHTML = '<p style="color: #666;">ì²˜ë¦¬ ì¤‘...</p>';
            document.getElementById('videoProgressSection').style.display = 'block';

            try {
                const response = await fetch('/api/process-youtube', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        youtube_url: youtubeUrl,
                        stt_service: sttService
                    })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.cached) {
                        displayVideoResult(data);
                    } else if (data.processing) {
                        videoTaskId = data.task_id;
                        startVideoProgressPolling();
                    }
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                    document.getElementById('videoProgressSection').style.display = 'none';
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                document.getElementById('videoProgressSection').style.display = 'none';
            }
        });

        // ì˜ìƒ ì§„í–‰ ìƒí™© í´ë§
        function startVideoProgressPolling() {
            if (videoProgressInterval) {
                clearInterval(videoProgressInterval);
            }

            videoProgressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/progress/${videoTaskId}`);
                    const data = await response.json();

                    if (data.success) {
                        const progress = data.progress;

                        if (progress.download) {
                            updateVideoProgress('download', progress.download.progress, progress.download.message);
                        }

                        if (progress.stt) {
                            updateVideoProgress('stt', progress.stt.progress, progress.stt.message);
                        }

                        if (progress.completed && progress.result) {
                            clearInterval(videoProgressInterval);
                            displayVideoResult(progress.result);
                        }

                        if (progress.error) {
                            clearInterval(videoProgressInterval);
                            alert('ì˜¤ë¥˜: ' + progress.error.message);
                            document.getElementById('videoProgressSection').style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('ì§„í–‰ ìƒí™© ì¡°íšŒ ì˜¤ë¥˜:', error);
                }
            }, 1000);
        }

        function updateVideoProgress(type, percent, message) {
            const progressSpan = document.getElementById(`video${type.charAt(0).toUpperCase() + type.slice(1)}Progress`);
            const progressBar = document.getElementById(`video${type.charAt(0).toUpperCase() + type.slice(1)}ProgressBar`);
            const messageDiv = document.getElementById(`video${type.charAt(0).toUpperCase() + type.slice(1)}Message`);

            if (progressSpan) progressSpan.textContent = `${percent}%`;
            if (progressBar) progressBar.style.width = `${percent}%`;
            if (messageDiv) messageDiv.textContent = message;
        }

        // ì˜ìƒ ê²°ê³¼ í‘œì‹œ
        function displayVideoResult(data) {
            videoSessionId = data.session_id;
            videoId = data.video_id;
            videoSegments = data.segments;

            // ì—…ë¡œë“œ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('videoUploadSection').style.display = 'none';
            document.getElementById('videoViewerSection').style.display = 'block';

            // ì˜ìƒ ì •ë³´ í‘œì‹œ
            document.getElementById('videoInfo').innerHTML = `
                <div class="info-row">
                    <div class="info-item">
                        <strong>ì œëª©:</strong> <span>${data.title}</span>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-item">
                        <strong>ì±„ë„:</strong> <span>${data.channel}</span>
                    </div>
                    <div class="info-item">
                        <strong>ì¡°íšŒìˆ˜:</strong> <span>${data.view_count.toLocaleString()}</span>
                    </div>
                    <div class="info-item">
                        <strong>ì—…ë¡œë“œ ë‚ ì§œ:</strong> <span>${data.upload_date}</span>
                    </div>
                    <div class="info-item">
                        <strong>ì²˜ë¦¬ ì¼ì‹œ:</strong> <span>${data.created_at}</span>
                    </div>
                </div>
            `;

            // YouTube Player ì´ˆê¸°í™”
            if (!youtubePlayer) {
                youtubePlayer = new YT.Player('youtubePlayer', {
                    videoId: data.video_id,
                    width: '100%',
                    height: '400',
                    playerVars: {
                        'autoplay': 0,
                        'controls': 1
                    },
                    events: {
                        'onReady': onYouTubePlayerReady,
                        'onStateChange': onYouTubePlayerStateChange
                    }
                });
            } else {
                youtubePlayer.loadVideoById(data.video_id);
            }

            // íšŒì˜ë¡ í‘œì‹œ
            displayVideoTranscript(data.segments);

            // ìš”ì•½ ë¨¼ì € ì´ˆê¸°í™” (ë¬´ì¡°ê±´)
            document.getElementById('videoSummaryContent').innerHTML = '<p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>';

            // ìš”ì•½ì´ ìˆê³  ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ í‘œì‹œ
            if (data.summary && data.summary.trim() !== '') {
                document.getElementById('videoSummaryContent').innerHTML = marked.parse(data.summary);
                console.log('[Video] Loaded cached summary.');
            }

            // ì±„íŒ… ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì˜ìƒì´ë¯€ë¡œ)
            document.getElementById('videoChatMessages').innerHTML = `
                <div class="chat-welcome">
                    íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                </div>
            `;
            videoChatHistory = [];

            // ì§„í–‰ ìƒí™© ìˆ¨ê¸°ê¸°
            document.getElementById('videoProgressSection').style.display = 'none';

            console.log('[Video] New video loaded. Summary and chat initialized.');
        }

        // ì˜ìƒ íšŒì˜ë¡ í‘œì‹œ
        function displayVideoTranscript(segments) {
            const transcriptContent = document.getElementById('videoTranscriptContent');
            transcriptContent.innerHTML = '';

            segments.forEach(segment => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'transcript-segment';
                segmentDiv.dataset.time = segment.start_time;
                segmentDiv.dataset.id = segment.id;

                const minutes = Math.floor(segment.start_time / 60);
                const seconds = Math.floor(segment.start_time % 60);
                const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                segmentDiv.innerHTML = `
                    <div class="segment-header">
                        <span class="segment-speaker">í™”ì ${segment.speaker}</span>
                        <span class="segment-time">${timeStr}</span>
                    </div>
                    <div class="segment-text">${segment.text}</div>
                `;

                segmentDiv.addEventListener('click', () => {
                    if (youtubePlayer) {
                        youtubePlayer.seekTo(segment.start_time, true);
                    }
                });

                transcriptContent.appendChild(segmentDiv);
            });

            document.getElementById('videoSegmentInfo').textContent = `ì´ ${segments.length}ê°œ ì„¸ê·¸ë¨¼íŠ¸`;
        }

        // ì˜ìƒ ìš”ì•½ ìƒì„±
        document.getElementById('videoGenerateSummaryBtn').addEventListener('click', async () => {
            document.getElementById('videoSummaryLoading').style.display = 'block';
            document.getElementById('videoSummaryContent').innerHTML = '';

            try {
                const response = await fetch('/api/summarize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        segments: videoSegments,
                        session_id: videoSessionId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('videoSummaryContent').innerHTML = marked.parse(data.summary);
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('videoSummaryLoading').style.display = 'none';
            }
        });

        // ì˜ìƒ ì±„íŒ… ì „ì†¡
        document.getElementById('videoSendChatBtn').addEventListener('click', () => sendVideoChatMessage());
        document.getElementById('videoChatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendVideoChatMessage();
            }
        });

        async function sendVideoChatMessage() {
            const chatInput = document.getElementById('videoChatInput');
            const message = chatInput.value.trim();

            if (!message) return;

            const chatMessages = document.getElementById('videoChatMessages');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message user-message';
            userMessageDiv.innerHTML = `<div class="message-content">${message}</div>`;
            chatMessages.appendChild(userMessageDiv);

            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            document.getElementById('videoChatLoading').style.display = 'block';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        segments: videoSegments,
                        session_id: videoSessionId,
                        chat_history: videoChatHistory
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = 'chat-message ai-message';
                    aiMessageDiv.innerHTML = `<div class="message-content">${marked.parse(data.response)}</div>`;
                    chatMessages.appendChild(aiMessageDiv);

                    videoChatHistory = data.chat_history;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ì±„íŒ… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('videoChatLoading').style.display = 'none';
            }
        }

        // ì˜ìƒ ì±„íŒ… ì´ˆê¸°í™”
        document.getElementById('videoClearChatBtn').addEventListener('click', () => {
            if (confirm('ëŒ€í™” ë‚´ì—­ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('videoChatMessages').innerHTML = `
                    <div class="chat-welcome">
                        íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                    </div>
                `;
                videoChatHistory = [];
            }
        });

        // ì˜ìƒ ë³€ê²½
        document.getElementById('changeVideoBtn').addEventListener('click', () => {
            if (confirm('í˜„ì¬ ì‘ì—…ì„ ì¢…ë£Œí•˜ê³  ìƒˆë¡œìš´ ì˜ìƒì„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ë·°ì–´ ì„¹ì…˜ ìˆ¨ê¸°ê³  ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
                document.getElementById('videoViewerSection').style.display = 'none';
                document.getElementById('videoUploadSection').style.display = 'block';
                document.getElementById('youtubeUrl').value = '';

                // ìš”ì•½ ì´ˆê¸°í™”
                document.getElementById('videoSummaryContent').innerHTML = '<p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>';

                // ì±„íŒ… ì´ˆê¸°í™”
                document.getElementById('videoChatMessages').innerHTML = `
                    <div class="chat-welcome">
                        íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                    </div>
                `;
                videoChatHistory = [];

                // íšŒì˜ë¡ ì´ˆê¸°í™”
                document.getElementById('videoTranscriptContent').innerHTML = '';
                videoSegments = [];
                videoSessionId = null;
                videoId = null;

                // YouTube Player ì •ë¦¬
                if (videoHighlightInterval) {
                    clearInterval(videoHighlightInterval);
                    videoHighlightInterval = null;
                }

                console.log('[Video] Session cleared. Ready for new video.');
            }
        });

        // ì˜ìƒ ìë™ ìŠ¤í¬ë¡¤ í† ê¸€
        document.getElementById('videoAutoScrollToggle').addEventListener('click', function() {
            videoAutoScrollEnabled = !videoAutoScrollEnabled;
            this.classList.toggle('active');
            this.textContent = videoAutoScrollEnabled ? 'ìë™ ìŠ¤í¬ë¡¤: ON' : 'ìë™ ìŠ¤í¬ë¡¤: OFF';
        });

        // YouTube í”Œë ˆì´ì–´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        let videoHighlightInterval = null;

        function onYouTubePlayerReady(event) {
            // í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ì—ˆì„ ë•Œ
        }

        function onYouTubePlayerStateChange(event) {
            // ì¬ìƒ ì¤‘ì¼ ë•Œë§Œ í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
            if (event.data === YT.PlayerState.PLAYING) {
                console.log('[Video] Player started playing. Starting highlight updates.');
                if (videoHighlightInterval) {
                    clearInterval(videoHighlightInterval);
                }
                videoHighlightInterval = setInterval(() => {
                    if (youtubePlayer && youtubePlayer.getCurrentTime) {
                        const currentTime = youtubePlayer.getCurrentTime();
                        console.log('[Video] Current time:', currentTime.toFixed(2), 's');
                        highlightCurrentVideoSegment(currentTime);
                    }
                }, 100); // 100msë§ˆë‹¤ ì—…ë°ì´íŠ¸
            } else {
                // ì¼ì‹œì •ì§€, ì •ì§€ ë“±
                console.log('[Video] Player paused/stopped. Stopping highlight updates.');
                if (videoHighlightInterval) {
                    clearInterval(videoHighlightInterval);
                    videoHighlightInterval = null;
                }
            }
        }

        // ì˜ìƒ ì¬ìƒ ì‹œê°„ì— ë”°ë¼ í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ í•˜ì´ë¼ì´íŠ¸
        function highlightCurrentVideoSegment(currentTime) {
            if (!videoSegments || videoSegments.length === 0) {
                console.warn('[Video Highlight] No video segments available');
                return;
            }

            // í˜„ì¬ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ì„¸ê·¸ë¨¼íŠ¸ ì°¾ê¸°
            let currentSegment = null;
            for (let i = 0; i < videoSegments.length; i++) {
                const segment = videoSegments[i];
                const nextSegment = videoSegments[i + 1];

                if (nextSegment) {
                    if (currentTime >= segment.start_time && currentTime < nextSegment.start_time) {
                        currentSegment = segment;
                        break;
                    }
                } else {
                    if (currentTime >= segment.start_time) {
                        currentSegment = segment;
                        break;
                    }
                }
            }

            if (currentSegment) {
                console.log('[Video Highlight] Found segment:', {
                    id: currentSegment.id,
                    speaker: currentSegment.speaker,
                    start_time: currentSegment.start_time
                });

                // ëª¨ë“  ì„¸ê·¸ë¨¼íŠ¸ì—ì„œ active-audio í´ë˜ìŠ¤ ì œê±°
                const allSegments = document.querySelectorAll('#videoTranscriptContent .transcript-segment');
                allSegments.forEach(seg => seg.classList.remove('active-audio'));

                // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ì— active-audio í´ë˜ìŠ¤ ì¶”ê°€
                const currentSegmentElement = document.querySelector(
                    `#videoTranscriptContent .transcript-segment[data-id="${currentSegment.id}"]`
                );

                if (currentSegmentElement) {
                    console.log('[Video Highlight] âœ… Adding active-audio to segment ID:', currentSegment.id);
                    currentSegmentElement.classList.add('active-audio');

                    // ìë™ ìŠ¤í¬ë¡¤ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ íšŒì˜ë¡ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œë§Œ ìŠ¤í¬ë¡¤
                    if (videoAutoScrollEnabled) {
                        const transcriptContainer = document.getElementById('videoTranscriptContent');

                        // ë” ì •í™•í•œ ìœ„ì¹˜ ê³„ì‚°ì„ ìœ„í•´ getBoundingClientRect ì‚¬ìš©
                        const containerRect = transcriptContainer.getBoundingClientRect();
                        const elementRect = currentSegmentElement.getBoundingClientRect();

                        // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ ìœ„ì¹˜ ê³„ì‚°
                        const relativeTop = elementRect.top - containerRect.top + transcriptContainer.scrollTop;
                        const containerHeight = transcriptContainer.clientHeight;
                        const elementHeight = currentSegmentElement.offsetHeight;

                        // ìš”ì†Œë¥¼ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ì— ìœ„ì¹˜ì‹œí‚¤ê¸°
                        const scrollTo = relativeTop - (containerHeight / 2) + (elementHeight / 2);

                        transcriptContainer.scrollTo({
                            top: scrollTo,
                            behavior: 'smooth'
                        });

                        console.log('[Video Highlight] Container height:', containerHeight, 'Element relative top:', relativeTop, 'Scrolling to:', scrollTo);
                    }
                } else {
                    console.error('[Video Highlight] âŒ Could not find segment element with data-id:', currentSegment.id);
                }
            }
        }

        // ========================================
        // ì˜¤ë””ì˜¤ ê²€ìƒ‰ íƒ­ ë¡œì§
        // ========================================

        // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­
        const fileUploadArea = document.getElementById('fileUploadArea');
        const audioFileInput = document.getElementById('audioFileInput');
        const fileInfo = document.getElementById('fileInfo');
        const audioSubmitBtn = document.getElementById('audioSubmitBtn');

        fileUploadArea.addEventListener('click', () => {
            audioFileInput.click();
        });

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('drag-over');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('drag-over');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        audioFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        function handleFileSelect(file) {
            selectedAudioFile = file;

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileType').textContent = file.type || 'ì•Œ ìˆ˜ ì—†ìŒ';
            fileInfo.classList.add('show');

            audioSubmitBtn.disabled = false;
        }

        // ì˜¤ë””ì˜¤ í¼ ì œì¶œ
        document.getElementById('audioForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedAudioFile) {
                alert('ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const sttService = document.querySelector('input[name="audio_stt_service"]:checked').value;

            const formData = new FormData();
            formData.append('audio_file', selectedAudioFile);
            formData.append('stt_service', sttService);

            document.getElementById('audioUploadStatus').innerHTML = '<p style="color: #666;">ì²˜ë¦¬ ì¤‘...</p>';
            document.getElementById('audioProgressSection').style.display = 'block';
            audioSubmitBtn.disabled = true;

            try {
                const response = await fetch('/api/process-audio', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    if (data.cached) {
                        displayAudioResult(data);
                    } else if (data.processing) {
                        audioTaskId = data.task_id;
                        startAudioProgressPolling();
                    }
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                    document.getElementById('audioProgressSection').style.display = 'none';
                    audioSubmitBtn.disabled = false;
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                document.getElementById('audioProgressSection').style.display = 'none';
                audioSubmitBtn.disabled = false;
            }
        });

        // ì˜¤ë””ì˜¤ ì§„í–‰ ìƒí™© í´ë§
        function startAudioProgressPolling() {
            if (audioProgressInterval) {
                clearInterval(audioProgressInterval);
            }

            audioProgressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/progress/${audioTaskId}`);
                    const data = await response.json();

                    if (data.success) {
                        const progress = data.progress;

                        if (progress.stt) {
                            updateAudioProgress('stt', progress.stt.progress, progress.stt.message);
                        }

                        if (progress.completed && progress.result) {
                            clearInterval(audioProgressInterval);
                            displayAudioResult(progress.result);
                        }

                        if (progress.error) {
                            clearInterval(audioProgressInterval);
                            alert('ì˜¤ë¥˜: ' + progress.error.message);
                            document.getElementById('audioProgressSection').style.display = 'none';
                            audioSubmitBtn.disabled = false;
                        }
                    }
                } catch (error) {
                    console.error('ì§„í–‰ ìƒí™© ì¡°íšŒ ì˜¤ë¥˜:', error);
                }
            }, 1000);
        }

        function updateAudioProgress(type, percent, message) {
            const progressSpan = document.getElementById(`audio${type.charAt(0).toUpperCase() + type.slice(1)}Progress`);
            const progressBar = document.getElementById(`audio${type.charAt(0).toUpperCase() + type.slice(1)}ProgressBar`);
            const messageDiv = document.getElementById(`audio${type.charAt(0).toUpperCase() + type.slice(1)}Message`);

            if (progressSpan) progressSpan.textContent = `${percent}%`;
            if (progressBar) progressBar.style.width = `${percent}%`;
            if (messageDiv) messageDiv.textContent = message;
        }

        // ì˜¤ë””ì˜¤ ê²°ê³¼ í‘œì‹œ
        function displayAudioResult(data) {
            audioSessionId = data.session_id;
            audioSegments = data.segments;

            // ì—…ë¡œë“œ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('audioUploadSection').style.display = 'none';
            document.getElementById('audioViewerSection').style.display = 'block';

            // ì˜¤ë””ì˜¤ ì •ë³´ í‘œì‹œ
            const audioDurationMin = Math.floor(data.audio_duration / 60);
            const audioDurationSec = Math.floor(data.audio_duration % 60);
            const audioDurationStr = `${audioDurationMin}ë¶„ ${audioDurationSec}ì´ˆ`;

            document.getElementById('audioContentInfo').innerHTML = `
                <div class="info-row">
                    <div class="info-item">
                        <strong>íŒŒì¼ëª…:</strong> <span>${data.filename}</span>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-item">
                        <strong>íŒŒì¼ í¬ê¸°:</strong> <span>${formatFileSize(data.file_size)}</span>
                    </div>
                    <div class="info-item">
                        <strong>ì˜¤ë””ì˜¤ ê¸¸ì´:</strong> <span>${audioDurationStr}</span>
                    </div>
                    <div class="info-item">
                        <strong>ì²˜ë¦¬ ì¼ì‹œ:</strong> <span>${data.created_at}</span>
                    </div>
                    <div class="info-item">
                        <strong>STT ì²˜ë¦¬ ì‹œê°„:</strong> <span>${data.stt_processing_time.toFixed(2)}ì´ˆ</span>
                    </div>
                </div>
            `;

            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì„¤ì •
            const audioPath = data.file_path.replace(/\\/g, '/');
            const audioUrl = `/uploads/${audioPath.split('/').pop()}`;

            audioElement = document.getElementById('audioPlayer');
            audioElement.src = audioUrl;

            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            if (audioTimeUpdateHandler) {
                audioElement.removeEventListener('timeupdate', audioTimeUpdateHandler);
            }

            // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì •ì˜
            audioTimeUpdateHandler = () => {
                const currentTime = audioElement.currentTime;
                console.log('[Audio] Current time:', currentTime.toFixed(2), 's');
                highlightCurrentAudioSegment(currentTime);
            };

            // ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œê°„ì— ë”°ë¼ ëŒ€í™” í•˜ì´ë¼ì´íŠ¸
            audioElement.addEventListener('timeupdate', audioTimeUpdateHandler);
            console.log('[Audio] Event listener attached. Total segments:', audioSegments.length);

            // íšŒì˜ë¡ í‘œì‹œ
            displayAudioTranscript(data.segments);

            // ìš”ì•½ ë¨¼ì € ì´ˆê¸°í™” (ë¬´ì¡°ê±´)
            document.getElementById('audioSummaryContent').innerHTML = '<p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>';

            // ìš”ì•½ì´ ìˆê³  ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ í‘œì‹œ
            if (data.summary && data.summary.trim() !== '') {
                document.getElementById('audioSummaryContent').innerHTML = marked.parse(data.summary);
                console.log('[Audio] Loaded cached summary.');
            }

            // ì±„íŒ… ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì˜¤ë””ì˜¤ì´ë¯€ë¡œ)
            document.getElementById('audioChatMessages').innerHTML = `
                <div class="chat-welcome">
                    íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                </div>
            `;
            audioChatHistory = [];

            // ì§„í–‰ ìƒí™© ìˆ¨ê¸°ê¸°
            document.getElementById('audioProgressSection').style.display = 'none';
            audioSubmitBtn.disabled = false;

            console.log('[Audio] New audio loaded. Summary and chat initialized.');
        }

        // ì˜¤ë””ì˜¤ íšŒì˜ë¡ í‘œì‹œ
        function displayAudioTranscript(segments) {
            const transcriptContent = document.getElementById('audioTranscriptContent');
            transcriptContent.innerHTML = '';

            segments.forEach(segment => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'transcript-segment';
                segmentDiv.dataset.time = segment.start_time;
                segmentDiv.dataset.id = segment.id;

                const minutes = Math.floor(segment.start_time / 60);
                const seconds = Math.floor(segment.start_time % 60);
                const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                segmentDiv.innerHTML = `
                    <div class="segment-header">
                        <span class="segment-speaker">í™”ì ${segment.speaker}</span>
                        <span class="segment-time">${timeStr}</span>
                    </div>
                    <div class="segment-text">${segment.text}</div>
                `;

                segmentDiv.addEventListener('click', () => {
                    if (audioElement) {
                        audioElement.currentTime = segment.start_time;
                        audioElement.play();
                    }
                });

                transcriptContent.appendChild(segmentDiv);
            });

            document.getElementById('audioSegmentInfo').textContent = `ì´ ${segments.length}ê°œ ì„¸ê·¸ë¨¼íŠ¸`;
        }

        // ì˜¤ë””ì˜¤ ìš”ì•½ ìƒì„±
        document.getElementById('audioGenerateSummaryBtn').addEventListener('click', async () => {
            document.getElementById('audioSummaryLoading').style.display = 'block';
            document.getElementById('audioSummaryContent').innerHTML = '';

            try {
                const response = await fetch('/api/summarize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        segments: audioSegments,
                        session_id: audioSessionId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('audioSummaryContent').innerHTML = marked.parse(data.summary);
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('audioSummaryLoading').style.display = 'none';
            }
        });

        // ì˜¤ë””ì˜¤ ì±„íŒ… ì „ì†¡
        document.getElementById('audioSendChatBtn').addEventListener('click', () => sendAudioChatMessage());
        document.getElementById('audioChatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAudioChatMessage();
            }
        });

        async function sendAudioChatMessage() {
            const chatInput = document.getElementById('audioChatInput');
            const message = chatInput.value.trim();

            if (!message) return;

            const chatMessages = document.getElementById('audioChatMessages');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message user-message';
            userMessageDiv.innerHTML = `<div class="message-content">${message}</div>`;
            chatMessages.appendChild(userMessageDiv);

            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            document.getElementById('audioChatLoading').style.display = 'block';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        segments: audioSegments,
                        session_id: audioSessionId,
                        chat_history: audioChatHistory
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = 'chat-message ai-message';
                    aiMessageDiv.innerHTML = `<div class="message-content">${marked.parse(data.response)}</div>`;
                    chatMessages.appendChild(aiMessageDiv);

                    audioChatHistory = data.chat_history;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ì±„íŒ… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('audioChatLoading').style.display = 'none';
            }
        }

        // ì˜¤ë””ì˜¤ ì±„íŒ… ì´ˆê¸°í™”
        document.getElementById('audioClearChatBtn').addEventListener('click', () => {
            if (confirm('ëŒ€í™” ë‚´ì—­ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('audioChatMessages').innerHTML = `
                    <div class="chat-welcome">
                        íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                    </div>
                `;
                audioChatHistory = [];
            }
        });

        // ì˜¤ë””ì˜¤ ë³€ê²½
        document.getElementById('changeAudioBtn').addEventListener('click', () => {
            if (confirm('í˜„ì¬ ì‘ì—…ì„ ì¢…ë£Œí•˜ê³  ìƒˆë¡œìš´ ì˜¤ë””ì˜¤ë¥¼ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ë·°ì–´ ì„¹ì…˜ ìˆ¨ê¸°ê³  ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
                document.getElementById('audioViewerSection').style.display = 'none';
                document.getElementById('audioUploadSection').style.display = 'block';
                selectedAudioFile = null;
                fileInfo.classList.remove('show');
                audioSubmitBtn.disabled = true;

                // ìš”ì•½ ì´ˆê¸°í™”
                document.getElementById('audioSummaryContent').innerHTML = '<p class="summary-placeholder">ìš”ì•½ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>';

                // ì±„íŒ… ì´ˆê¸°í™”
                document.getElementById('audioChatMessages').innerHTML = `
                    <div class="chat-welcome">
                        íšŒì˜ë¡ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                    </div>
                `;
                audioChatHistory = [];

                // íšŒì˜ë¡ ì´ˆê¸°í™”
                document.getElementById('audioTranscriptContent').innerHTML = '';
                audioSegments = [];
                audioSessionId = null;

                // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì •ë¦¬
                if (audioElement) {
                    audioElement.pause();
                    audioElement.src = '';
                }

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
                if (audioTimeUpdateHandler) {
                    audioElement.removeEventListener('timeupdate', audioTimeUpdateHandler);
                    audioTimeUpdateHandler = null;
                }

                console.log('[Audio] Session cleared. Ready for new audio.');
            }
        });

        // ì˜¤ë””ì˜¤ ìë™ ìŠ¤í¬ë¡¤ í† ê¸€
        document.getElementById('audioAutoScrollToggle').addEventListener('click', function() {
            audioAutoScrollEnabled = !audioAutoScrollEnabled;
            this.classList.toggle('active');
            this.textContent = audioAutoScrollEnabled ? 'ìë™ ìŠ¤í¬ë¡¤: ON' : 'ìë™ ìŠ¤í¬ë¡¤: OFF';
        });

        // ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œê°„ì— ë”°ë¼ í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ í•˜ì´ë¼ì´íŠ¸
        function highlightCurrentAudioSegment(currentTime) {
            if (!audioSegments || audioSegments.length === 0) {
                console.warn('[Audio Highlight] No audio segments available');
                return;
            }

            // í˜„ì¬ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ì„¸ê·¸ë¨¼íŠ¸ ì°¾ê¸°
            let currentSegment = null;
            for (let i = 0; i < audioSegments.length; i++) {
                const segment = audioSegments[i];
                const nextSegment = audioSegments[i + 1];

                if (nextSegment) {
                    // í˜„ì¬ ì‹œê°„ì´ ì´ ì„¸ê·¸ë¨¼íŠ¸ì™€ ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ ì‚¬ì´ì— ìˆëŠ”ì§€ í™•ì¸
                    if (currentTime >= segment.start_time && currentTime < nextSegment.start_time) {
                        currentSegment = segment;
                        break;
                    }
                } else {
                    // ë§ˆì§€ë§‰ ì„¸ê·¸ë¨¼íŠ¸
                    if (currentTime >= segment.start_time) {
                        currentSegment = segment;
                        break;
                    }
                }
            }

            if (currentSegment) {
                console.log('[Audio Highlight] Found segment:', {
                    id: currentSegment.id,
                    speaker: currentSegment.speaker,
                    start_time: currentSegment.start_time,
                    text: currentSegment.text.substring(0, 50) + '...'
                });

                // ëª¨ë“  ì„¸ê·¸ë¨¼íŠ¸ì—ì„œ active-audio í´ë˜ìŠ¤ ì œê±°
                const allSegments = document.querySelectorAll('#audioTranscriptContent .transcript-segment');
                console.log('[Audio Highlight] Removing active-audio from', allSegments.length, 'segments');
                allSegments.forEach(seg => seg.classList.remove('active-audio'));

                // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ì— active-audio í´ë˜ìŠ¤ ì¶”ê°€
                const currentSegmentElement = document.querySelector(
                    `#audioTranscriptContent .transcript-segment[data-id="${currentSegment.id}"]`
                );

                if (currentSegmentElement) {
                    console.log('[Audio Highlight] âœ… Adding active-audio to segment ID:', currentSegment.id);
                    currentSegmentElement.classList.add('active-audio');

                    // í´ë˜ìŠ¤ê°€ ì‹¤ì œë¡œ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    const hasClass = currentSegmentElement.classList.contains('active-audio');
                    console.log('[Audio Highlight] Class added successfully:', hasClass);

                    // í˜„ì¬ ì ìš©ëœ ìŠ¤íƒ€ì¼ í™•ì¸
                    const styles = window.getComputedStyle(currentSegmentElement);
                    console.log('[Audio Highlight] Background:', styles.background);
                    console.log('[Audio Highlight] Border-left:', styles.borderLeft);

                    // ìë™ ìŠ¤í¬ë¡¤ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ íšŒì˜ë¡ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œë§Œ ìŠ¤í¬ë¡¤
                    if (audioAutoScrollEnabled) {
                        const transcriptContainer = document.getElementById('audioTranscriptContent');

                        // ë” ì •í™•í•œ ìœ„ì¹˜ ê³„ì‚°ì„ ìœ„í•´ getBoundingClientRect ì‚¬ìš©
                        const containerRect = transcriptContainer.getBoundingClientRect();
                        const elementRect = currentSegmentElement.getBoundingClientRect();

                        // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ ìœ„ì¹˜ ê³„ì‚°
                        const relativeTop = elementRect.top - containerRect.top + transcriptContainer.scrollTop;
                        const containerHeight = transcriptContainer.clientHeight;
                        const elementHeight = currentSegmentElement.offsetHeight;

                        // ìš”ì†Œë¥¼ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ì— ìœ„ì¹˜ì‹œí‚¤ê¸°
                        const scrollTo = relativeTop - (containerHeight / 2) + (elementHeight / 2);

                        transcriptContainer.scrollTo({
                            top: scrollTo,
                            behavior: 'smooth'
                        });

                        console.log('[Audio Highlight] Container height:', containerHeight, 'Element relative top:', relativeTop, 'Scrolling to:', scrollTo);
                    }
                } else {
                    console.error('[Audio Highlight] âŒ Could not find segment element with data-id:', currentSegment.id);
                    // ëª¨ë“  ì„¸ê·¸ë¨¼íŠ¸ì˜ data-id ì¶œë ¥í•˜ì—¬ ë””ë²„ê¹…
                    const allIds = Array.from(allSegments).map(seg => seg.dataset.id);
                    console.log('[Audio Highlight] Available segment IDs:', allIds);
                }
            }
        }

        // Marked.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        document.head.appendChild(script);
    </script>
</body>
</html>
